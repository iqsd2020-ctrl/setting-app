<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المطور - وحي أهل البيت (ع)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Reem+Kufi:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <style>
        /* Base Styles */
        body { font-family: 'Amiri', serif; background: #0f172a; color: #f1f5f9; min-height: 100vh; overflow-x: hidden; }
        
        /* Glass Effect */
        .glass { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); border-radius: 1rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        
        /* Inputs */
        .input-box { width: 100%; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: white; padding: 0.7rem; border-radius: 0.5rem; outline: none; transition: 0.3s; font-size: 0.95rem; }
        .input-box:focus { border-color: #d97706; box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.15); background: rgba(15, 23, 42, 1); }
        .input-box:disabled { opacity: 0.6; cursor: not-allowed; background: #1e293b; }
        
        /* Custom Select Arrow */
        select.input-box { appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23fbbf24' stroke-width='2' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: left 0.75rem center; background-repeat: no-repeat; background-size: 1.25em; }
        
        /* Buttons */
        .btn-gold { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color: white; font-weight: bold; padding: 0.75rem; border-radius: 0.5rem; transition: 0.3s; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.25); border: 1px solid #d97706; }
        .btn-gold:hover { filter: brightness(1.15); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(217, 119, 6, 0.4); }
        .btn-gold:active { transform: translateY(0); }
        
        /* Sidebar Navigation */
        .nav-item { padding: 1rem; color: #94a3b8; cursor: pointer; border-right: 3px solid transparent; transition: 0.3s; display: flex; align-items: center; gap: 0.75rem; font-family: 'Reem Kufi', sans-serif; }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-item.active { background: linear-gradient(90deg, rgba(217, 119, 6, 0.15), transparent); color: #fbbf24; border-right-color: #fbbf24; }
        
        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: #1e293b; width: 95%; max-width: 650px; border-radius: 1rem; padding: 1.5rem; border: 1px solid #475569; transform: scale(0.95) translateY(10px); transition: 0.3s; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }

        /* Items List */
        .admin-item { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.05); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .admin-item:hover { border-color: #fbbf24; background: rgba(30, 41, 59, 0.8); transform: translateX(-4px); }
        
        /* Utilities */
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 6px; } 
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #d97706; }
        .spinner { animation: spin 1s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex items-center justify-center text-right selection:bg-amber-500 selection:text-white">

    <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#0f172a] bg-[url('https://www.transparenttextures.com/patterns/arabesque.png')]">
        <div class="glass p-8 md:p-10 text-center w-full max-w-sm md:max-w-md border border-amber-500/30 relative overflow-hidden shadow-2xl">
            <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-amber-500/20 to-transparent rounded-bl-full"></div>
            <span class="material-symbols-rounded text-6xl text-amber-500 mb-6 drop-shadow-lg block">admin_panel_settings</span>
            <h1 class="text-3xl font-bold text-white mb-2 font-[Reem_Kufi]">لوحة المطور</h1>
            <p class="text-slate-400 text-sm mb-8">نظام إدارة وحي أهل البيت (ع)</p>
            
            <div class="relative group">
                <input type="password" id="admin-pin" class="input-box text-center text-3xl tracking-[0.5em] bg-black/40 border-slate-600 h-16 font-mono text-amber-500 placeholder-slate-700 mb-6 group-hover:border-amber-500/50" placeholder="••••" maxlength="4">
            </div>
            
            <button id="btn-login" class="btn-gold w-full shadow-lg flex items-center justify-center gap-2 text-lg">
                <span>تسجيل الدخول</span> <span class="material-symbols-rounded">login</span>
            </button>
            <p id="login-msg" class="text-red-400 text-sm mt-4 h-5 font-bold transition-all"></p>
        </div>
    </div>

    <div id="dashboard-container" class="hidden w-full h-screen flex overflow-hidden">
        
        <div class="w-20 md:w-72 bg-[#1e293b] border-l border-slate-700 flex flex-col hidden md:flex shadow-2xl z-20 relative transition-all duration-300">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-500 to-amber-700"></div>
            <div class="p-4 md:p-8 text-center border-b border-slate-700 bg-slate-900/30">
                <h2 class="text-amber-500 font-bold text-lg md:text-2xl font-[Reem_Kufi] drop-shadow-md">المنصة الإدارية</h2>
                <div class="mt-1 md:mt-2 text-[8px] md:text-[10px] text-slate-500 uppercase tracking-widest">Admin Control Panel v7</div>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 md:py-6 space-y-1">
                <div class="nav-item active" data-tab="view-dashboard"><span class="material-symbols-rounded text-xl">analytics</span> <span class="hidden md:inline">نظرة عامة</span></div>
                <div class="nav-item" data-tab="view-users"><span class="material-symbols-rounded text-xl">manage_accounts</span> <span class="hidden md:inline">إدارة المستخدمين</span></div>
                <div class="nav-item" data-tab="view-content"><span class="material-symbols-rounded text-xl">post_add</span> <span class="hidden md:inline">إضافة محتوى</span></div>
                <div class="nav-item" data-tab="view-manage"><span class="material-symbols-rounded text-xl">library_books</span> <span class="hidden md:inline">بنك الأسئلة</span></div>
                <div class="nav-item" data-tab="view-system"><span class="material-symbols-rounded text-xl">settings_applications</span> <span class="hidden md:inline">إعدادات النظام</span></div>
            </nav>
            <div class="p-4 md:p-6 border-t border-slate-700 bg-slate-900/30">
                <button onclick="location.reload()" class="w-full flex items-center justify-center gap-3 text-red-400 hover:text-red-200 hover:bg-red-500/10 p-2 md:p-3 rounded-lg transition text-sm font-bold border border-transparent hover:border-red-500/30">
                    <span class="material-symbols-rounded">power_settings_new</span> <span class="hidden md:inline">تسجيل خروج</span>
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-[#0f172a] h-full relative">
            
            <div class="md:hidden bg-[#1e293b] p-4 flex justify-between items-center border-b border-slate-700 shadow-md z-30 sticky top-0">
                <h2 class="text-amber-500 font-bold font-[Reem_Kufi] text-lg">لوحة التحكم</h2>
                <button class="text-slate-300 hover:text-white p-2 rounded-lg active:bg-slate-700" onclick="document.querySelector('.mobile-nav').classList.toggle('hidden')">
                    <span class="material-symbols-rounded text-2xl">menu</span>
                </button>
            </div>
            
            <div class="mobile-nav hidden md:hidden bg-slate-800/95 backdrop-blur-md border-b border-slate-700 p-2 grid grid-cols-5 gap-1 text-center shadow-xl z-20 absolute top-[60px] w-full">
                <button class="p-3 text-slate-400 hover:text-amber-500 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-dashboard')"><span class="material-symbols-rounded">analytics</span><span class="text-[10px]">الرئيسية</span></button>
                <button class="p-3 text-slate-400 hover:text-amber-500 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-users')"><span class="material-symbols-rounded">group</span><span class="text-[10px]">المستخدمين</span></button>
                <button class="p-3 text-slate-400 hover:text-amber-500 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-content')"><span class="material-symbols-rounded">add</span><span class="text-[10px]">إضافة</span></button>
                <button class="p-3 text-slate-400 hover:text-amber-500 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-manage')"><span class="material-symbols-rounded">list</span><span class="text-[10px]">البنك</span></button>
                <button class="p-3 text-slate-400 hover:text-amber-500 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-system')"><span class="material-symbols-rounded">settings</span><span class="text-[10px]">النظام</span></button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth" id="main-view-area">
                
                <div id="view-dashboard" class="view-section space-y-4 md:space-y-8 fade-in">
                    <h3 class="text-xl md:text-2xl text-white font-bold border-b border-slate-700 pb-3 md:pb-4 flex items-center gap-3">
                        <span class="material-symbols-rounded text-amber-500 bg-amber-500/10 p-2 rounded-lg">dashboard</span>
                        لوحة القيادة العامة
                    </h3>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-5">
                        <div class="glass p-4 md:p-6 text-center border-t-4 border-blue-500 hover:bg-slate-800 transition group">
                            <span class="material-symbols-rounded text-3xl md:text-4xl text-blue-400 mb-2 group-hover:scale-110 transition">group</span>
                            <div class="text-3xl md:text-4xl font-bold text-white font-mono" id="dash-users-count">-</div>
                            <div class="text-[10px] md:text-xs text-slate-400 mt-1 font-bold uppercase">إجمالي المستخدمين</div>
                        </div>
                        <div class="glass p-4 md:p-6 text-center border-t-4 border-green-500 hover:bg-slate-800 transition group">
                            <span class="material-symbols-rounded text-3xl md:text-4xl text-green-400 mb-2 group-hover:scale-110 transition">quiz</span>
                            <div class="text-3xl md:text-4xl font-bold text-white font-mono" id="dash-questions-count">-</div>
                            <div class="text-[10px] md:text-xs text-slate-400 mt-1 font-bold uppercase">إجمالي الأسئلة</div>
                        </div>
                        <div class="glass p-4 md:p-6 text-center border-t-4 border-purple-500 hover:bg-slate-800 transition group">
                            <span class="material-symbols-rounded text-3xl md:text-4xl text-purple-400 mb-2 group-hover:scale-110 transition">category</span>
                            <div class="text-3xl md:text-4xl font-bold text-white font-mono" id="dash-topics-count">6</div>
                            <div class="text-[10px] md:text-xs text-slate-400 mt-1 font-bold uppercase">الأقسام النشطة</div>
                        </div>
                        <div class="glass p-4 md:p-6 text-center border-t-4 border-red-500 hover:bg-slate-800 transition group">
                            <span class="material-symbols-rounded text-3xl md:text-4xl text-red-400 mb-2 group-hover:scale-110 transition">block</span>
                            <div class="text-3xl md:text-4xl font-bold text-white font-mono" id="dash-banned-count">-</div>
                            <div class="text-[10px] md:text-xs text-slate-400 mt-1 font-bold uppercase">المحظورين</div>
                        </div>
                    </div>
                    
                    <div class="glass p-4 md:p-6 mt-4 md:mt-6 border border-slate-700/50">
                        <h4 class="text-lg md:text-xl text-white font-bold mb-3 md:mb-4 flex items-center gap-2">
                            <span class="material-symbols-rounded">pie_chart</span> توزيع الأسئلة حسب المواضيع
                        </h4>
                        <div class="h-64 w-full flex justify-center">
                            <canvas id="questionsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="view-users" class="view-section hidden space-y-4 md:space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-800/40 p-4 md:p-5 rounded-xl border border-slate-700/50 backdrop-blur-sm">
                        <h3 class="text-lg md:text-xl text-white font-bold flex items-center gap-3">
                            <span class="material-symbols-rounded text-blue-400 bg-blue-400/10 p-2 rounded-lg">people_alt</span> 
                            قائمة المستخدمين
                        </h3>
                        <div class="flex gap-3 w-full md:w-auto">
                            <div class="relative w-full md:w-72">
                                <span class="material-symbols-rounded absolute right-3 top-2.5 text-slate-500 pointer-events-none">search</span>
                                <input type="text" id="user-search" placeholder="بحث بالاسم أو ID..." class="input-box pr-10 py-2 text-sm bg-slate-900/50">
                            </div>
                            <button id="btn-refresh-users" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg shadow-lg transition active:scale-95">
                                <span class="material-symbols-rounded">sync</span>
                            </button>
                        </div>
                    </div>
                    <div id="users-grid" class="grid grid-cols-1 gap-3"></div>
                </div>

                <div id="view-content" class="view-section hidden space-y-4 md:space-y-8 fade-in">
                    <h3 class="text-xl md:text-2xl text-white font-bold mb-3 md:mb-4 flex items-center gap-3 border-b border-slate-700 pb-3 md:pb-4">
                        <span class="material-symbols-rounded text-green-500 bg-green-500/10 p-2 rounded-lg">add_circle</span> 
                        إدارة المحتوى
                    </h3>
                    
                    <div class="glass p-6 md:p-8 border border-blue-500/20 relative overflow-hidden group hover:border-blue-500/40 transition">
                        <div class="absolute top-0 left-0 bg-blue-500/20 w-full h-1 group-hover:h-1.5 transition-all duration-500"></div>
                        <h4 class="text-lg md:text-xl text-blue-400 font-bold mb-4 md:mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded">cloud_upload</span> رفع ملف (Upload JSON)
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-5 mb-4 md:mb-6">
                            <select id="upload-cat" class="input-box text-sm"></select>
                            <select id="upload-topic" class="input-box text-sm" disabled></select>
                            <select id="upload-diff" class="input-box text-sm"><option value="متوسط">متوسط</option><option value="سهل">سهل</option><option value="صعب">صعب</option></select>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 items-center bg-slate-800/40 p-4 md:p-5 rounded-xl border border-slate-700 border-dashed hover:bg-slate-800/60 transition">
                            <input type="file" id="json-file-input" accept=".json" class="text-xs md:text-sm text-slate-400 w-full file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
                            <button id="btn-upload-file" class="bg-blue-600 text-white px-6 md:px-8 py-2.5 rounded-lg shadow-lg hover:bg-blue-700 text-sm font-bold whitespace-nowrap w-full md:w-auto flex justify-center gap-2 items-center">
                                بدء الرفع <span class="material-symbols-rounded text-sm">upload_file</span>
                            </button>
                        </div>
                    </div>

                    <div class="glass p-6 md:p-8 border border-purple-500/20 relative overflow-hidden group hover:border-purple-500/40 transition">
                        <div class="absolute top-0 left-0 bg-purple-500/20 w-full h-1 group-hover:h-1.5 transition-all duration-500"></div>
                        <h4 class="text-lg md:text-xl text-purple-400 font-bold mb-4 md:mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded">content_paste_go</span> لصق كود JSON
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-5 mb-4 md:mb-5">
                            <select id="paste-cat" class="input-box text-sm"></select>
                            <select id="paste-topic" class="input-box text-sm" disabled></select>
                            <select id="paste-diff" class="input-box text-sm"><option value="متوسط">متوسط</option><option value="سهل">سهل</option><option value="صعب">صعب</option></select>
                        </div>
                        <textarea id="json-paste-area" class="input-box h-32 md:h-48 font-mono text-xs text-left mb-4 md:mb-5 bg-slate-900/80 border-slate-700 focus:border-purple-500 leading-relaxed" dir="ltr" placeholder='[
    {
        "question": "سؤال...",
        "options": ["أ", "ب", "ج", "د"],
        "correctAnswer": 0,
        "explanation": "شرح..."
    }
]'></textarea>
                        <button id="btn-paste-upload" class="bg-purple-600 hover:bg-purple-700 text-white w-full py-3 rounded-lg font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-[0.99]">
                            معالجة وإضافة المحتوى <span class="material-symbols-rounded">save_as</span>
                        </button>
                    </div>

                    <div class="glass p-6 md:p-8 border border-green-500/20 relative overflow-hidden group hover:border-green-500/40 transition">
                        <div class="absolute top-0 left-0 bg-green-500/20 w-full h-1 group-hover:h-1.5 transition-all duration-500"></div>
                        <h4 class="text-lg md:text-xl text-green-400 font-bold mb-4 md:mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded">edit_square</span> المحرر اليدوي
                        </h4>
                        <div class="space-y-4 md:space-y-5">
                            <div class="relative">
                                <label class="text-xs text-slate-400 mb-1 block mr-1">نص السؤال</label>
                                <input id="man-q" type="text" class="input-box text-base md:text-lg font-bold placeholder-slate-600 bg-slate-800" placeholder="اكتب السؤال هنا...">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                <div class="flex items-center gap-3 bg-slate-800/40 p-3 rounded-lg border border-slate-700 hover:border-green-500/50 transition cursor-pointer" onclick="document.querySelector('input[name=correct_ans_selector][value=0]').checked=true">
                                    <input type="radio" name="correct_ans_selector" value="0" checked class="w-5 h-5 accent-green-500 cursor-pointer">
                                    <input id="man-o1" type="text" class="bg-transparent text-white w-full outline-none text-sm border-b border-transparent focus:border-green-500/50 px-1 transition" placeholder="الخيار الأول">
                                </div>
                                <div class="flex items-center gap-3 bg-slate-800/40 p-3 rounded-lg border border-slate-700 hover:border-green-500/50 transition cursor-pointer" onclick="document.querySelector('input[name=correct_ans_selector][value=1]').checked=true">
                                    <input type="radio" name="correct_ans_selector" value="1" class="w-5 h-5 accent-green-500 cursor-pointer">
                                    <input id="man-o2" type="text" class="bg-transparent text-white w-full outline-none text-sm border-b border-transparent focus:border-green-500/50 px-1 transition" placeholder="الخيار الثاني">
                                </div>
                                <div class="flex items-center gap-3 bg-slate-800/40 p-3 rounded-lg border border-slate-700 hover:border-green-500/50 transition cursor-pointer" onclick="document.querySelector('input[name=correct_ans_selector][value=2]').checked=true">
                                    <input type="radio" name="correct_ans_selector" value="2" class="w-5 h-5 accent-green-500 cursor-pointer">
                                    <input id="man-o3" type="text" class="bg-transparent text-white w-full outline-none text-sm border-b border-transparent focus:border-green-500/50 px-1 transition" placeholder="الخيار الثالث">
                                </div>
                                <div class="flex items-center gap-3 bg-slate-800/40 p-3 rounded-lg border border-slate-700 hover:border-green-500/50 transition cursor-pointer" onclick="document.querySelector('input[name=correct_ans_selector][value=3]').checked=true">
                                    <input type="radio" name="correct_ans_selector" value="3" class="w-5 h-5 accent-green-500 cursor-pointer">
                                    <input id="man-o4" type="text" class="bg-transparent text-white w-full outline-none text-sm border-b border-transparent focus:border-green-500/50 px-1 transition" placeholder="الخيار الرابع">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs text-slate-400 mb-1 block mr-1">معلومة إثرائية</label>
                                <textarea id="man-exp" class="input-box h-16 md:h-20 text-sm resize-none" placeholder="تظهر بعد الإجابة..."></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 pt-2 bg-slate-900/30 p-3 md:p-4 rounded-xl border border-slate-700">
                                <div><label class="text-[10px] text-slate-400 block mb-1">التصنيف</label><select id="man-cat" class="input-box text-xs py-2"></select></div>
                                <div><label class="text-[10px] text-slate-400 block">الموضوع</label><select id="man-topic" class="input-box text-xs py-2" disabled></select></div>
                                <div><label class="text-[10px] text-slate-400 block">الصعوبة</label><select id="man-diff" class="input-box text-xs py-2"><option value="متوسط">متوسط</option><option value="سهل">سهل</option><option value="صعب">صعب</option></select></div>
                                <div class="flex items-end"><button id="btn-man-save" class="btn-gold text-sm h-[38px] w-full font-bold shadow-md">حفظ وإضافة</button></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-manage" class="view-section hidden space-y-4 md:space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-800/40 p-4 md:p-5 rounded-xl border border-slate-700/50">
                        <h3 class="text-lg md:text-xl text-white font-bold flex items-center gap-3">
                            <span class="material-symbols-rounded text-purple-400 bg-purple-400/10 p-2 rounded-lg">library_books</span> 
                            بنك الأسئلة
                            <span id="qs-counter" class="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded-full font-mono">0</span>
                        </h3>
                        
                        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                            <div class="relative flex-1 md:w-80">
                                <span class="material-symbols-rounded absolute right-3 top-2.5 text-purple-400 text-sm pointer-events-none">auto_read_play</span>
                                <input type="text" id="qs-search-input" placeholder="البحث الذكي: ابدأ بكتابة نص السؤال..." class="input-box pr-9 py-2 text-sm bg-slate-900/50 border-slate-600 focus:border-purple-500">
                            </div>

                            <select id="manage-filter" class="input-box text-sm md:w-48 bg-slate-900/50 border-slate-600"><option value="">كل الأقسام</option></select>
                            
                            <button id="btn-refresh-qs" title="تحديث القائمة" class="bg-slate-600 text-white px-3 rounded-lg hover:bg-slate-500 shadow-lg transition active:scale-95 flex items-center justify-center">
                                <span class="material-symbols-rounded">sync</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-slate-800/20 rounded-xl p-2 min-h-[400px] flex flex-col">
                        <div id="questions-grid" class="space-y-3 mb-4"></div>
                        
                        <button id="btn-load-more" class="hidden w-full py-3 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-lg border border-dashed border-slate-600 transition flex justify-center items-center gap-2 text-sm font-bold">
                            تحميل المزيد من الأسئلة <span class="material-symbols-rounded">expand_more</span>
                        </button>
                    </div>
                </div>

                <div id="view-system" class="view-section hidden space-y-4 md:space-y-8 fade-in">
                    <h3 class="text-xl md:text-2xl text-white font-bold mb-3 md:mb-4 flex items-center gap-3 border-b border-slate-700 pb-3 md:pb-4">
                        <span class="material-symbols-rounded text-slate-400 bg-slate-700/30 p-2 rounded-lg">settings</span> 
                        إعدادات النظام
                    </h3>

                    <div class="glass p-6 md:p-8 space-y-5 border-r-4 border-r-green-500">
                        <h4 class="text-lg md:text-xl text-green-400 font-bold flex items-center gap-2">
                            <span class="material-symbols-rounded">download_for_offline</span> تصدير حزم الأسئلة المحددة
                        </h4>
                        <p class="text-slate-400 text-sm mt-1">اختر الموضوع ومستوى الصعوبة لتنزيل ملف JSON يحتوي على الأسئلة المطابقة فقط.</p>
                        
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <div><label class="text-[10px] text-slate-400 block mb-1">التصنيف</label><select id="export-cat" class="input-box text-xs py-2"></select></div>
                            
                            <div><label class="text-[10px] text-slate-400 block">الموضوع</label><select id="export-topic" class="input-box text-xs py-2" disabled></select></div>
                            
                            <div><label class="text-[10px] text-slate-400 block">الصعوبة</label><select id="export-diff" class="input-box text-xs py-2">
                                <option value="">كل المستويات</option>
                                <option value="سهل">سهل</option>
                                <option value="متوسط">متوسط</option>
                                <option value="صعب">صعب</option>
                            </select></div>
                            
                            <div class="flex items-end">
                                <button id="btn-export-filtered" class="bg-green-600 hover:bg-green-700 text-white w-full py-2.5 rounded-lg text-sm font-bold flex justify-center gap-2 transition" disabled>
                                    تصدير الأسئلة <span class="material-symbols-rounded text-sm">download</span>
                                </button>
                            </div>
                        </div>
                        <p id="export-msg" class="text-xs text-red-400 h-4"></p>
                    </div>

                    
                    <div class="glass p-6 md:p-8 flex flex-col md:flex-row items-center justify-between gap-6 border-r-4 border-r-blue-500">
                        <div>
                            <h4 class="text-lg md:text-xl text-white font-bold flex items-center gap-2"><span class="material-symbols-rounded text-blue-400">save</span> النسخ الاحتياطي الكامل</h4>
                            <p class="text-sm text-slate-400 mt-1">قم بتصدير قاعدة البيانات بالكامل إلى ملف JSON آمن.</p>
                        </div>
                        <button id="btn-backup" class="bg-blue-600 text-white px-6 md:px-8 py-3 rounded-lg hover:bg-blue-700 text-sm font-bold flex gap-2 shadow-xl transform transition hover:scale-105">
                            تصدير البيانات <span class="material-symbols-rounded text-sm">download</span>
                        </button>
                    </div>

                    <div class="glass p-6 md:p-8 border border-red-500/20 bg-red-900/5 flex flex-col md:flex-row items-center justify-between gap-6 border-r-4 border-r-red-600">
                        <div>
                            <h4 class="text-lg md:text-xl text-red-400 font-bold flex items-center gap-2"><span class="material-symbols-rounded">dangerous</span> منطقة الخطر</h4>
                            <p class="text-sm text-slate-400 mt-1">حذف جميع الأسئلة نهائياً من قاعدة البيانات (لا يمكن التراجع).</p>
                        </div>
                        <button id="btn-nuke" class="bg-red-900 hover:bg-red-800 text-red-200 border border-red-700/50 px-6 md:px-8 py-3 rounded-lg text-sm font-bold flex gap-2 shadow-xl transform transition hover:scale-105">
                            تصفير النظام <span class="material-symbols-rounded text-sm">delete_forever</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="user-edit-modal" class="modal-overlay">
        <div class="modal-content border-t-4 border-t-amber-500 p-4 md:p-6">
            <div class="flex justify-between items-center mb-4 md:mb-6 border-b border-slate-700 pb-3 md:pb-4">
                <h3 class="text-lg md:text-xl font-bold text-amber-500 flex items-center gap-2"><span class="material-symbols-rounded">manage_accounts</span> تعديل المستخدم</h3>
                <button class="close-modal text-slate-400 hover:text-white bg-slate-800 rounded-full p-2 transition"><span class="material-symbols-rounded text-lg">close</span></button>
            </div>
            <div class="flex flex-col md:flex-row gap-4 md:gap-6 mb-4 md:mb-8">
                <div class="flex flex-col items-center gap-3">
                    <div id="edit-avatar-container" class="w-20 h-20 md:w-24 md:h-24 rounded-full bg-slate-800 border-4 border-amber-500/30 flex items-center justify-center overflow-hidden shadow-inner relative"></div>
                    <button id="btn-remove-avatar" class="text-xs text-red-400 hover:text-red-200 hover:underline transition">حذف الصورة</button>
                </div>
                <div class="flex-1 space-y-4 md:space-y-5 pt-1">
                    <div>
                        <label class="text-slate-400 text-xs font-bold block mb-1.5 uppercase tracking-wider">الاسم الظاهر</label>
                        <input type="text" id="edit-name" class="input-box text-sm bg-slate-900 border-slate-700 focus:border-amber-500">
                    </div>
                    <div>
                        <label class="text-slate-400 text-xs font-bold block mb-1.5 uppercase tracking-wider">النقاط (Score)</label>
                        <input type="number" id="edit-score" class="input-box text-sm bg-slate-900 border-slate-700 font-mono text-amber-500 font-bold">
                    </div>
                </div>
            </div>
            <div class="bg-slate-800/40 p-4 md:p-5 rounded-xl border border-slate-700 mb-4 md:mb-6">
                <label class="flex items-center justify-between cursor-pointer group">
                    <div class="flex items-center gap-3">
                        <div class="bg-red-500/10 p-2 rounded-lg text-red-500"><span class="material-symbols-rounded">block</span></div>
                        <div>
                            <span class="text-white text-sm font-bold block group-hover:text-red-400 transition">حظر الحساب (Ban)</span>
                            <span class="text-[10px] text-slate-500 block">منع المستخدم من الدخول للتطبيق</span>
                        </div>
                    </div>
                    <input type="checkbox" id="edit-banned" class="w-6 h-6 accent-red-500 rounded cursor-pointer">
                </label>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button id="btn-save-user" class="btn-gold py-3 text-sm shadow-md">حفظ التغييرات</button>
                <button id="btn-delete-user" class="bg-transparent border border-red-500/30 text-red-400 hover:bg-red-500/10 hover:border-red-500 py-3 rounded-lg text-sm transition font-bold">حذف الحساب نهائياً</button>
            </div>
        </div>
    </div>

    <div id="question-edit-modal" class="modal-overlay">
        <div class="modal-content border-t-4 border-t-blue-500 p-4 md:p-6">
            <div class="flex justify-between items-center mb-4 md:mb-6 border-b border-slate-700 pb-3 md:pb-4">
                <h3 class="text-lg md:text-xl font-bold text-blue-500 flex items-center gap-2"><span class="material-symbols-rounded">edit_note</span> تحرير السؤال</h3>
                <button class="close-q-modal text-slate-400 hover:text-white bg-slate-800 rounded-full p-2 transition"><span class="material-symbols-rounded text-lg">close</span></button>
            </div>
            <div class="space-y-4 md:space-y-5">
                <div>
                    <label class="text-xs text-slate-400 block mb-1.5 font-bold">نص السؤال</label>
                    <input id="edit-q-text" type="text" class="input-box text-base md:text-lg font-bold bg-slate-800 border-slate-600 focus:border-blue-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                    <div class="flex items-center gap-3 bg-slate-800/40 p-3 rounded-lg border border-slate-700 focus-within:border-blue-500 transition"><input type="radio" name="edit_ans_selector" value="0" class="w-5 h-5 accent-blue-500 cursor-pointer"><input id="edit-o1" type="text" class="bg-transparent text-white w-full outline-none text-sm px-1"></div>
                    <div class="flex items-center gap-3 bg-slate-800/40 p-3 rounded-lg border border-slate-700 focus-within:border-blue-500 transition"><input type="radio" name="edit_ans_selector" value="1" class="w-5 h-5 accent-blue-500 cursor-pointer"><input id="edit-o2" type="text" class="bg-transparent text-white w-full outline-none text-sm px-1"></div>
                    <div class="flex items-center gap-3 bg-slate-800/40 p-3 rounded-lg border border-slate-700 focus-within:border-blue-500 transition"><input type="radio" name="edit_ans_selector" value="2" class="w-5 h-5 accent-blue-500 cursor-pointer"><input id="edit-o3" type="text" class="bg-transparent text-white w-full outline-none text-sm px-1"></div>
                    <div class="flex items-center gap-3 bg-slate-800/40 p-3 rounded-lg border border-slate-700 focus-within:border-blue-500 transition"><input type="radio" name="edit_ans_selector" value="3" class="w-5 h-5 accent-blue-500 cursor-pointer"><input id="edit-o4" type="text" class="bg-transparent text-white w-full outline-none text-sm px-1"></div>
                </div>
                <div>
                    <label class="text-xs text-slate-400 block mb-1.5 font-bold">الشرح / المعلومة الإثرائية</label>
                    <textarea id="edit-q-exp" class="input-box h-16 md:h-20 text-sm resize-none bg-slate-800/50"></textarea>
                </div>
                <div class="grid grid-cols-3 gap-3 bg-slate-900/30 p-4 rounded-xl border border-slate-700">
                    <div><label class="text-[10px] text-slate-400 block mb-1">التصنيف</label><select id="edit-q-cat" class="input-box text-xs py-2"></select></div>
                    <div><label class="text-[10px] text-slate-400 block">الموضوع</label><select id="edit-q-topic" class="input-box text-xs py-2"></select></div>
                    <div><label class="text-[10px] text-slate-400 block">الصعوبة</label><select id="edit-q-diff" class="input-box text-xs py-2"><option value="متوسط">متوسط</option><option value="سهل">سهل</option><option value="صعب">صعب</option></select></div>
                </div>
                <div class="pt-2">
                    <button id="btn-save-edit-q" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-3.5 rounded-lg font-bold shadow-lg transition active:scale-[0.99] flex justify-center gap-2 items-center">
                        حفظ التعديلات <span class="material-symbols-rounded text-sm">save</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900/95 text-white px-8 py-4 rounded-2xl shadow-2xl border border-amber-500/40 hidden z-[80] flex items-center gap-4 transition-all duration-300 backdrop-blur-md min-w-[320px] justify-center">
        <span class="material-symbols-rounded text-amber-500 text-2xl" id="toast-icon">check_circle</span>
        <span id="toast-msg" class="text-sm font-bold"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { 
            getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, 
            query, where, orderBy, limit, serverTimestamp, writeBatch, 
            startAfter 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp({ apiKey: "AIzaSyDY1FNxvECtaV_dflCzkRH4pHQi_HQ4fwA", authDomain: "all-in-b0422.firebaseapp.com", projectId: "all-in-b0422", storageBucket: "all-in-b0422.firebasestorage.app", messagingSenderId: "347315641241", appId: "1:347315641241:web:c9ed240a00e5d2c5031108" });
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Auth State
        let isAuthReady = false;
        signInAnonymously(auth).then(() => { isAuthReady = true; console.log("Admin Auth Ready"); }).catch(e => console.error(e));

        // UI Helpers
        const el = (id) => document.getElementById(id);
        const show = (id) => el(id).classList.remove('hidden');
        const hide = (id) => el(id).classList.add('hidden');
        const toast = (msg, icon = 'check_circle') => { 
            el('toast-msg').innerText = msg; el('toast-icon').innerText = icon; 
            const t = el('toast'); t.classList.remove('hidden'); t.classList.add('flex'); t.style.opacity = "1"; t.style.transform = "translate(-50%, 0)";
            setTimeout(() => { t.style.opacity = "0"; t.style.transform = "translate(-50%, 20px)"; setTimeout(() => { t.classList.add('hidden'); t.classList.remove('flex'); }, 300); }, 3000); 
        };

        // Data Structure
        const topics = {
            "المعصومون (عليهم السلام)": ["سيرة النبي محمد (ص)", "سيرة الإمام علي (ع)", "السيدة فاطمة الزهراء (ع)", "سيرة الإمام الحسن المجتبى (ع)", "سيرة الإمام الحسين (ع)", "سيرة الإمام السجاد (ع)", "سيرة الإمام الباقر (ع)", "سيرة الإمام الصادق (ع)", "سيرة الإمام الكاظم (ع)", "سيرة الإمام الرضا (ع)", "سيرة الإمام الجواد (ع)", "سيرة الإمام الهادي (ع)", "سيرة الإمام العسكري (ع)", "الإمام المهدي (عج)"],
            "الأنبياء والرسل": ["أولو العزم من الرسل", "سيرة النبي إبراهيم (ع)", "سيرة النبي موسى (ع)", "سيرة النبي عيسى (ع)", "سيرة النبي يوسف (ع)", "سيرة النبي سليمان (ع)"],
            "شخصيات (أصحاب وعلماء)": ["السيدة زينب (ع)", "أبو الفضل العباس (ع)", "سلمان المحمدي", "عمار بن ياسر", "المختار الثقفي", "مالك الأشتر", "مسلم بن عقيل (ع)"],
            "عقائد وفقه": ["اصول الدين", "العدل الإلهي", "الإمامة", "المعاد", "الرجعة", "فروع الدين", "الصلاة اليومية", "الخمس", "علامات الظهور"],
            "تاريخ ومعارك": ["واقعة كربلاء", "يوم المباهلة", "عيد الغدير", "معركة صفين", "حرب الجمل", "فتح مكة"],
            "أدعية وزيارات": ["دعاء كميل", "دعاء الندبة", "زيارة عاشوراء", "زيارة الأربعين", "الزيارة الجامعة"]
        };

        // --- LOGIN & NAVIGATION ---
        el('btn-login').onclick = () => {
            if(!isAuthReady) { el('login-msg').innerText = "جاري الاتصال بالقاعدة..."; return; }
            if(el('admin-pin').value === '0000') { 
                hide('login-screen'); show('dashboard-container'); loadStats(); 
            } else { 
                el('login-msg').innerText = "رمز الدخول خاطئ!"; 
                el('admin-pin').value = ''; el('admin-pin').focus();
                setTimeout(()=>el('login-msg').innerText='', 2000); 
            }
        };

        window.triggerTab = (tabId) => {
            document.querySelectorAll('.nav-item').forEach(b => { b.classList.remove('active'); if(b.dataset.tab === tabId) b.classList.add('active'); });
            document.querySelectorAll('.mobile-nav button').forEach(b => b.classList.remove('text-amber-500'));
            document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
            show(tabId);
            if(tabId === 'view-users') loadUsers();
            if(tabId === 'view-manage') { 
                el('qs-search-input').value = ''; 
                currentSearchTerm = '';
                loadQuestions(false); 
            }
            if(tabId === 'view-dashboard') loadStats();
            document.querySelector('.mobile-nav').classList.add('hidden');
        };
        document.querySelectorAll('.nav-item').forEach(btn => btn.onclick = () => triggerTab(btn.dataset.tab));

        // --- DROPS & FILTERS ---
        const initDrops = (cId, tId) => {
            const c = el(cId), t = el(tId);
            c.innerHTML = '<option value="">-- اختر التصنيف --</option>';
            Object.keys(topics).forEach(k => c.add(new Option(k, k)));
            c.onchange = () => {
                t.innerHTML = '<option value="">-- اختر الموضوع --</option>';
                if(topics[c.value]) { t.disabled = false; topics[c.value].forEach(sub => t.add(new Option(sub, sub))); t.classList.remove('opacity-50'); } 
                else { t.disabled = true; t.classList.add('opacity-50'); }
            };
        };
        initDrops('upload-cat', 'upload-topic');
        initDrops('man-cat', 'man-topic');
        initDrops('paste-cat', 'paste-topic');
        initDrops('edit-q-cat', 'edit-q-topic');

        // دالة جديدة لتهيئة قوائم التصدير المخصصة
        const initExportDrops = (cId, tId, btnId) => {
            const c = el(cId), t = el(tId), btn = el(btnId);
            c.innerHTML = '<option value="">-- اختر التصنيف --</option>';
            Object.keys(topics).forEach(k => c.add(new Option(k, k)));
            
            const toggleButton = () => {
                btn.disabled = !t.value; // تفعيل الزر فقط إذا تم اختيار موضوع
                if (btn.disabled) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    el('export-msg').innerText = 'يجب اختيار الموضوع لتفعيل التصدير.';
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    el('export-msg').innerText = '';
                }
            };
            
            c.onchange = () => {
                t.innerHTML = '<option value="">-- اختر الموضوع --</option>';
                if(topics[c.value]) { t.disabled = false; topics[c.value].forEach(sub => t.add(new Option(sub, sub))); t.classList.remove('opacity-50'); } 
                else { t.disabled = true; t.classList.add('opacity-50'); }
                toggleButton();
            };

            t.onchange = toggleButton;
            el('export-diff').onchange = toggleButton; // يمكن التصدير مع كل مستويات الصعوبة
            toggleButton();
        };

        initExportDrops('export-cat', 'export-topic', 'btn-export-filtered');
        
        const mf = el('manage-filter');
        mf.innerHTML = '<option value="">عرض جميع الأسئلة (الأحدث أولاً)</option>';
        Object.keys(topics).forEach(cat => { const grp = document.createElement('optgroup'); grp.label = cat; topics[cat].forEach(sub => grp.appendChild(new Option(sub, sub))); mf.appendChild(grp); });

        // --- STATS (محدث بالرسم البياني) ---
        let myChart = null; 
        async function loadStats() {
            try {
                const qSnap = await getDocs(query(collection(db, "questions"))); el('dash-questions-count').innerText = qSnap.size;
                const uSnap = await getDocs(query(collection(db, "users"))); el('dash-users-count').innerText = uSnap.size;
                let b = 0; uSnap.forEach(d => { if(d.data().isBanned) b++; }); el('dash-banned-count').innerText = b;

                // كود الرسم البياني
                const topicCounts = {};
                qSnap.forEach(doc => {
                    const t = doc.data().topic || "غير مصنف";
                    topicCounts[t] = (topicCounts[t] || 0) + 1;
                });

                const ctx = document.getElementById('questionsChart').getContext('2d');
                if (myChart) myChart.destroy(); 

                myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(topicCounts),
                        datasets: [{
                            label: 'عدد الأسئلة',
                            data: Object.values(topicCounts),
                            backgroundColor: [
                                '#d97706', '#2563eb', '#16a34a', '#dc2626', '#9333ea', '#0891b2', '#475569', '#facc15', '#f472b6'
                            ],
                            borderColor: '#1e293b',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#cbd5e1', font: { family: 'Amiri' } } }
                        }
                    }
                });

            } catch(e) { console.error(e); }
        }

        // --- USERS MANAGEMENT ---
        let currentUserEditId = null;
        async function loadUsers() {
            const grid = el('users-grid');
            grid.innerHTML = '<div class="text-center py-12 text-amber-500"><span class="material-symbols-rounded spinner text-4xl">sync</span></div>';
            const term = el('user-search').value.toLowerCase();
            
            try {
                const q = query(collection(db, "users"), orderBy("highScore", "desc"), limit(50));
                const snap = await getDocs(q);
                
                grid.innerHTML = '';
                if(snap.empty) { grid.innerHTML = '<div class="text-center py-10 text-slate-500">لا يوجد مستخدمين</div>'; return; }
                
                snap.forEach(docSnap => {
                    const u = docSnap.data();
                    if(term && !u.name?.toLowerCase().includes(term) && !docSnap.id.includes(term)) return;
                    
                    const uidShort = docSnap.id.substring(0, 6).toUpperCase();
                    const displayName = u.name ? u.name : `<span class="text-slate-500 italic">ضيف #${uidShort}</span>`;

                    let av = '';
                    if(u.customAvatar) {
                        av = `<img src="${u.customAvatar}" class="w-12 h-12 rounded-full object-cover border-2 border-amber-500/50 shadow-md">`;
                    } else if(u.avatar) {
                        av = `<div class="w-12 h-12 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-amber-500 border border-slate-600"><span class="material-symbols-rounded text-2xl">${u.avatar}</span></div>`;
                    } else {
                        const char = u.name ? u.name[0] : '?';
                        av = `<div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-slate-300 font-bold text-lg">${char}</div>`;
                    }

                    const div = document.createElement('div');
                    div.className = `admin-item ${u.isBanned ? 'bg-red-900/10 border-red-500/30' : ''}`;
                    div.innerHTML = `
                        <div class="flex items-center gap-4 w-full">
                            <div class="relative shrink-0">
                                ${av}
                                ${u.isBanned ? '<span class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center bg-red-600 rounded-full border-2 border-[#0f172a]"><span class="material-symbols-rounded text-[10px] text-white">block</span></span>' : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-white font-bold text-base truncate mb-0.5">${displayName}</div>
                                <div class="text-[10px] text-slate-500 font-mono tracking-wider select-all cursor-pointer hover:text-blue-400 transition" title="نسخ المعرف">${docSnap.id}</div>
                            </div>
                            <div class="text-center px-2">
                                <div class="text-[10px] text-slate-400 uppercase tracking-widest">Score</div>
                                <div class="text-amber-400 font-bold font-mono text-lg">${u.highScore || 0}</div>
                            </div>
                            <button class="bg-slate-700 hover:bg-blue-600 text-white p-2.5 rounded-lg ml-2 transition shadow-lg active:scale-95" onclick="openUserModal('${docSnap.id}')" title="تعديل"><span class="material-symbols-rounded">edit</span></button>
                        </div>`;
                    div.querySelector('button').onclick = () => openUserModal(docSnap.id, u);
                    grid.appendChild(div);
                });
            } catch(e) { 
                console.error(e); 
                grid.innerHTML = '<div class="text-center text-red-400 p-4 border border-red-900/50 rounded bg-red-900/10">حدث خطأ في تحميل البيانات.</div>'; 
            }
        }
        
        el('btn-refresh-users').onclick = loadUsers;
        el('user-search').oninput = loadUsers;

        window.openUserModal = (uid, data) => {
            currentUserEditId = uid;
            el('edit-name').value = data.name || '';
            el('edit-score').value = data.highScore || 0;
            el('edit-banned').checked = data.isBanned || false;
            
            const avCon = el('edit-avatar-container');
            if(data.customAvatar) {
                avCon.innerHTML = `<img src="${data.customAvatar}" class="w-full h-full object-cover">`;
                show('btn-remove-avatar');
            } else if (data.avatar) {
                 avCon.innerHTML = `<span class="material-symbols-rounded text-4xl text-amber-500">${data.avatar}</span>`;
                 hide('btn-remove-avatar');
            } else {
                avCon.innerHTML = `<span class="material-symbols-rounded text-4xl text-slate-500">person</span>`;
                hide('btn-remove-avatar');
            }
            el('user-edit-modal').classList.add('active');
        };

        el('btn-save-user').onclick = async () => {
            if(!currentUserEditId) return;
            const btn = el('btn-save-user'); btn.innerText = "جاري الحفظ...";
            try {
                await updateDoc(doc(db, "users", currentUserEditId), { 
                    name: el('edit-name').value, 
                    highScore: parseInt(el('edit-score').value) || 0, 
                    isBanned: el('edit-banned').checked 
                });
                toast("تم تحديث المستخدم"); el('user-edit-modal').classList.remove('active'); loadUsers();
            } catch(e) { alert("Error: " + e.message); }
            btn.innerText = "حفظ التغييرات";
        };
        
        el('btn-delete-user').onclick = async () => {
            if(confirm("تحذير: الحذف نهائي! هل أنت متأكد؟")) { 
                await deleteDoc(doc(db, "users", currentUserEditId)); 
                toast("تم حذف الحساب", "delete"); el('user-edit-modal').classList.remove('active'); loadUsers(); 
            }
        };
        
        el('btn-remove-avatar').onclick = async () => {
            if(confirm("حذف الصورة الشخصية؟")) { 
                await updateDoc(doc(db, "users", currentUserEditId), { customAvatar: null }); 
                toast("تم حذف الصورة"); el('user-edit-modal').classList.remove('active'); loadUsers(); 
            }
        };
        document.querySelector('.close-modal').onclick = () => el('user-edit-modal').classList.remove('active');

        // --- CONTENT UPLOAD ---
        
        // 1. Manual Add
        el('btn-man-save').onclick = async () => {
            const q = el('man-q').value, o1 = el('man-o1').value, o2 = el('man-o2').value, o3 = el('man-o3').value, o4 = el('man-o4').value, topic = el('man-topic').value;
            const correctIndex = Array.from(document.getElementsByName('correct_ans_selector')).findIndex(r => r.checked);
            
            if(!q || !o1 || !o2 || !o3 || !o4 || !topic) return toast("يرجى تعبئة جميع الحقول واختيار الموضوع", "warning");
            
            const btn = el('btn-man-save'); const oldTxt = btn.innerText; btn.innerText = "جاري الإضافة..."; btn.disabled = true;
            try {
                await addDoc(collection(db, "questions"), { 
                    question: q, options: [o1,o2,o3,o4], correctAnswer: correctIndex, 
                    explanation: el('man-exp').value, topic: topic, difficulty: el('man-diff').value, 
                    createdAt: serverTimestamp() 
                });
                toast("تمت إضافة السؤال بنجاح");
                el('man-q').value=''; el('man-o1').value=''; el('man-o2').value=''; el('man-o3').value=''; el('man-o4').value=''; el('man-exp').value='';
                document.getElementsByName('correct_ans_selector')[0].checked = true;
            } catch(e) { alert("خطأ: " + e.message); }
            btn.innerText = oldTxt; btn.disabled = false;
        };

        // 2. File Upload
        el('btn-upload-file').onclick = () => {
            const file = el('json-file-input').files[0], topic = el('upload-topic').value, diff = el('upload-diff').value;
            if(!file || !topic) return toast("اختر ملف JSON وحدد الموضوع", "warning");
            
            const r = new FileReader();
            r.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(!Array.isArray(data)) throw new Error("يجب أن يكون الملف مصفوفة []");
                    
                    const btn = el('btn-upload-file'); btn.innerHTML = `<span class="spinner material-symbols-rounded">sync</span> جاري الرفع...`; btn.disabled = true;
                    
                    let count = 0;
                    for(const q of data) {
                         if(q.question && q.options) {
                            await addDoc(collection(db, "questions"), { 
                                question: q.question, options: q.options, correctAnswer: q.correctAnswer||0, 
                                explanation: q.explanation||"", topic, difficulty: diff, createdAt: serverTimestamp() 
                            });
                            count++;
                         }
                    }
                    toast(`تم رفع ${count} سؤال بنجاح`); btn.innerHTML = `بدء الرفع <span class="material-symbols-rounded text-sm">upload_file</span>`; btn.disabled = false;
                } catch(err) { alert("خطأ في الملف: " + err.message); }
            };
            r.readAsText(file);
        };

        // 3. Paste JSON
        el('btn-paste-upload').onclick = async () => {
            const txt = el('json-paste-area').value, topic = el('paste-topic').value, diff = el('paste-diff').value;
            if(!txt || !topic) return toast("الصق الكود وحدد الموضوع", "warning");
            
            const btn = el('btn-paste-upload'); const oldTxt = btn.innerText; btn.innerText = "جاري المعالجة..."; btn.disabled = true;
            try {
                const data = JSON.parse(txt);
                if(!Array.isArray(data)) throw new Error("يجب أن يكون الكود مصفوفة []");
                
                let count = 0;
                for(const q of data) {
                    if(q.question && q.options) {
                        await addDoc(collection(db, "questions"), { 
                            question: q.question, options: q.options, correctAnswer: q.correctAnswer || 0, 
                            explanation: q.explanation || "", topic: topic, difficulty: diff, createdAt: serverTimestamp() 
                        });
                        count++;
                    }
                }
                toast(`تمت إضافة ${count} سؤال`); el('json-paste-area').value = '';
            } catch(e) { alert("خطأ في تنسيق JSON:\n" + e.message); }
            btn.innerText = oldTxt; btn.disabled = false;
        };

        // --- MANAGE QUESTIONS (200 سؤال والبحث الذكي) ---
        let currentEditQId = null;
        let lastVisibleDoc = null; 
        const QUESTIONS_PER_PAGE = 200; 
        let isFetchingQs = false; 
        let currentSearchTerm = ""; 

        el('btn-refresh-qs').onclick = () => loadQuestions(false);
        el('manage-filter').onchange = () => loadQuestions(false);
        el('btn-load-more').onclick = () => loadQuestions(true);

        // دالة البحث الذكي (Server-side Search) - مع خاصية Debounce
        el('qs-search-input').oninput = function() {
            clearTimeout(window.searchTimer);
            window.searchTimer = setTimeout(() => {
                const newTerm = this.value.trim();
                if (newTerm !== currentSearchTerm) {
                    currentSearchTerm = newTerm;
                    loadQuestions(false); 
                }
            }, 500); 
        };

        async function loadQuestions(loadMore = false) {
            if (isFetchingQs) return; 
            isFetchingQs = true;

            const grid = el('questions-grid');
            const loadBtn = el('btn-load-more');
            const filterVal = el('manage-filter').value;
            
            if (!loadMore) {
                grid.innerHTML = '';
                lastVisibleDoc = null;
                el('qs-counter').innerText = '0';
                loadBtn.classList.add('hidden');
                grid.innerHTML = '<div id="q-loader" class="text-center py-12 text-slate-500"><span class="material-symbols-rounded spinner text-3xl">sync</span><p class="text-xs mt-2">جاري جلب البيانات...</p></div>';
            } else {
                loadBtn.innerHTML = '<span class="material-symbols-rounded spinner text-sm">sync</span> جاري التحميل...';
            }

            try {
                let constraints = [];
                
                // 1. الفلتر حسب الموضوع
                if (filterVal) {
                    constraints.push(where("topic", "==", filterVal));
                }

                // 2. البحث الذكي (Prefix Search)
                if (currentSearchTerm) {
                    constraints.push(orderBy("question"));
                    constraints.push(where("question", ">=", currentSearchTerm));
                    constraints.push(where("question", "<=", currentSearchTerm + '\uf8ff'));
                } else if (!filterVal) {
                    constraints.push(orderBy("createdAt", "desc"));
                } else {
                    constraints.push(orderBy("createdAt", "desc"));
                }
                
                // 3. الصفحة التالية (Pagination)
                if (loadMore && lastVisibleDoc) {
                    constraints.push(startAfter(lastVisibleDoc));
                }

                // 4. الحد الأقصى (200 سؤال)
                constraints.push(limit(QUESTIONS_PER_PAGE));

                const q = query(collection(db, "questions"), ...constraints);
                const snapshot = await getDocs(q);

                const loader = el('q-loader');
                if (loader) loader.remove();

                if (snapshot.empty) {
                    if (!loadMore) grid.innerHTML = '<div class="text-center py-8 text-slate-500 bg-slate-800/20 rounded border border-slate-700/50">لا توجد أسئلة مطابقة</div>';
                    loadBtn.classList.add('hidden');
                } else {
                    lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
                    
                    if (snapshot.docs.length < QUESTIONS_PER_PAGE) {
                        loadBtn.classList.add('hidden');
                    } else {
                        loadBtn.classList.remove('hidden');
                        loadBtn.innerHTML = 'تحميل المزيد من الأسئلة <span class="material-symbols-rounded">expand_more</span>';
                    }

                    snapshot.forEach(docSnap => {
                        const d = docSnap.data();
                        const div = document.createElement('div');
                        div.className = 'admin-item bg-slate-700/30 border-slate-700/50 hover:bg-slate-700/50 fade-in';
                        
                        let diffColor = d.difficulty === 'سهل' ? 'text-green-400 border-green-500/30' : (d.difficulty === 'صعب' ? 'text-red-400 border-red-500/30' : 'text-amber-400 border-amber-500/30');

                        div.innerHTML = `
                            <div class="flex-1 min-w-0 pr-2">
                                <div class="text-white text-sm font-bold mb-1.5 leading-relaxed">${d.question}</div>
                                <div class="flex flex-wrap gap-2 text-[10px]">
                                    <span class="bg-slate-800 px-2 py-0.5 rounded text-slate-300 border border-slate-600">${d.topic}</span>
                                    <span class="bg-slate-800 px-2 py-0.5 rounded border ${diffColor}">${d.difficulty || 'عام'}</span>
                                </div>
                            </div>
                            <div class="flex gap-2 shrink-0">
                                <button class="text-purple-400 hover:bg-purple-500/10 p-2 rounded-lg transition btn-dup-q" title="تكرار السؤال">
                                    <span class="material-symbols-rounded">content_copy</span>
                                </button>
                                <button class="text-blue-400 hover:bg-blue-500/10 p-2 rounded-lg transition btn-edit-q" title="تحرير"><span class="material-symbols-rounded">edit_note</span></button>
                                <button class="text-red-400 hover:bg-red-500/10 p-2 rounded-lg transition btn-del-q" title="حذف"><span class="material-symbols-rounded">delete</span></button>
                            </div>
                        `;

                        // أحداث الأزرار
                        div.querySelector('.btn-edit-q').onclick = () => openEditQModal(docSnap.id, d);
                        div.querySelector('.btn-del-q').onclick = async () => { 
                            if(confirm("حذف هذا السؤال نهائياً؟")) { 
                                await deleteDoc(doc(db, "questions", docSnap.id)); 
                                div.remove(); 
                                toast("تم الحذف", "delete");
                                el('qs-counter').innerText = document.querySelectorAll('#questions-grid .admin-item').length;
                            } 
                        };
                        div.querySelector('.btn-dup-q').onclick = async () => {
                            if(confirm("هل تريد إنشاء نسخة من هذا السؤال؟ سيتم إضافتها في الأعلى.")) {
                                try {
                                    const newQ = { ...d, createdAt: serverTimestamp(), question: d.question + " (نسخة)" };
                                    delete newQ.id; 
                                    await addDoc(collection(db, "questions"), newQ);
                                    toast("تم نسخ السؤال بنجاح");
                                    loadQuestions(false); 
                                } catch(e) { alert("خطأ في النسخ: " + e.message); }
                            }
                        };

                        grid.appendChild(div);
                    });
                    
                    el('qs-counter').innerText = document.querySelectorAll('#questions-grid .admin-item').length;
                }

            } catch(e) { 
                console.error(e); 
                grid.innerHTML += `<div class="text-center text-red-400 text-sm p-4 border border-red-500/20 bg-red-900/10 rounded mt-2">خطأ في جلب البيانات: ${e.message}</div>`; 
            }
            
            isFetchingQs = false;
        }


        window.openEditQModal = (docId, data) => {
            currentEditQId = docId;
            el('edit-q-text').value = data.question;
            el('edit-o1').value = data.options[0]; el('edit-o2').value = data.options[1]; el('edit-o3').value = data.options[2]; el('edit-o4').value = data.options[3];
            el('edit-q-exp').value = data.explanation || ""; el('edit-q-diff').value = data.difficulty || "متوسط";
            
            const radios = document.getElementsByName('edit_ans_selector');
            if(radios[data.correctAnswer]) radios[data.correctAnswer].checked = true;
            
            let foundCat = ""; for(const [cat, subTopics] of Object.entries(topics)) { if(subTopics.includes(data.topic)) { foundCat = cat; break; } }
            if(foundCat) { 
                el('edit-q-cat').value = foundCat; 
                el('edit-q-cat').dispatchEvent(new Event('change')); 
                el('edit-q-topic').value = data.topic; 
            }
            
            el('question-edit-modal').classList.add('active');
        };

        el('btn-save-edit-q').onclick = async () => {
            if(!currentEditQId) return;
            const q = el('edit-q-text').value, o1 = el('edit-o1').value, o2 = el('edit-o2').value, o3 = el('edit-o3').value, o4 = el('edit-o4').value, topic = el('edit-q-topic').value;
            const correctIndex = Array.from(document.getElementsByName('edit_ans_selector')).findIndex(r => r.checked);
            
            if(!q || !o1 || !o2 || !o3 || !o4 || !topic) return toast("بيانات ناقصة", "warning");
            
            const btn = el('btn-save-edit-q'); btn.innerText = "جاري الحفظ...";
            try {
                await updateDoc(doc(db, "questions", currentEditQId), { 
                    question: q, options: [o1,o2,o3,o4], correctAnswer: correctIndex, 
                    explanation: el('edit-q-exp').value, topic: topic, difficulty: el('edit-q-diff').value 
                });
                toast("تم تعديل السؤال"); el('question-edit-modal').classList.remove('active'); loadQuestions(false);
            } catch(e) { alert("Error: " + e.message); }
            btn.innerText = "حفظ التعديلات";
        };
        document.querySelector('.close-q-modal').onclick = () => el('question-edit-modal').classList.remove('active');

        // --- SYSTEM FUNCTIONS ---
        
        // 1. تصدير حزم الأسئلة المحددة (الجديدة)
        el('btn-export-filtered').onclick = exportFilteredQuestions;

        async function exportFilteredQuestions() {
            const btn = el('btn-export-filtered');
            const topic = el('export-topic').value;
            let difficulty = el('export-diff').value;
            const msg = el('export-msg');

            if (!topic) { msg.innerText = "الرجاء اختيار موضوع محدد."; return; }
            
            let btnText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner material-symbols-rounded text-sm">sync</span> جاري البحث...`;
            btn.disabled = true;
            msg.innerText = '';
            
            try {
                let constraints = [where('topic', '==', topic)];
                let filename = `Export_${topic.replace(/\s/g, '_')}`;

                if (difficulty) {
                    constraints.push(where('difficulty', '==', difficulty));
                    filename += `_${difficulty}`;
                    // هذا الاستعلام يتطلب فهرساً مركباً على topic و difficulty
                }

                // يجب طلب كل المستندات في الاستعلام، لذلك لا نستخدم limit هنا
                const q = query(collection(db, "questions"), ...constraints, orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    msg.innerText = "لم يتم العثور على أسئلة مطابقة.";
                    return;
                }

                const data = []; 
                snap.forEach(d => {
                    // إزالة معلومات Firebase الداخلية وجعل البيانات جاهزة للتصدير كحزمة
                    let qData = d.data();
                    delete qData.createdAt; 
                    data.push(qData);
                });

                // تحميل الملف
                const a=document.createElement('a'); 
                a.href=URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)],{type:'application/json'})); 
                a.download=`${filename}_(${snap.size}_Qs).json`; 
                a.click();
                
                toast(`تم تصدير ${snap.size} سؤال بنجاح!`);

            } catch(e) { 
                console.error(e);
                msg.innerText = `خطأ في التصدير. قد تحتاج لفهرس Firebase جديد: ${e.message}`;
                alert(`خطأ في التصدير: ${e.message}. يرجى مراجعة لوحة تحكم Firebase.`);
            } finally {
                btn.innerHTML = btnText;
                btn.disabled = false;
                // إعادة تفعيل زر التصدير بناءً على حالة القوائم المنسدلة
                el('export-topic').dispatchEvent(new Event('change'));
            }
        }
        
        // 2. النسخ الاحتياطي الكامل
        el('btn-backup').onclick = async () => {
            const btn = el('btn-backup'); btn.innerText = "جاري التجهيز...";
            try {
                const snap = await getDocs(query(collection(db, "questions"))); 
                const data=[]; snap.forEach(d=>data.push(d.data()));
                const a=document.createElement('a'); 
                a.href=URL.createObjectURL(new Blob([JSON.stringify(data)],{type:'application/json'})); 
                a.download=`Wahy_Backup_${new Date().toISOString().split('T')[0]}.json`; 
                a.click();
                toast("تم تحميل النسخة الاحتياطية");
            } catch(e) { alert("فشل التصدير"); }
            btn.innerHTML = 'تصدير البيانات <span class="material-symbols-rounded text-sm">download</span>';
        };
        
        // 3. تصفير النظام
        el('btn-nuke').onclick = async () => { 
            const code = "حذف الكل";
            if(prompt(`تحذير: سيتم مسح قاعدة البيانات! اكتب "${code}" للتأكيد:`) === code) { 
                const s=await getDocs(query(collection(db,"questions"))); 
                const b=writeBatch(db); let c=0;
                s.forEach(d=> { b.delete(d.ref); c++; }); 
                if(c>0) { await b.commit(); alert(`تم حذف ${c} سؤال.`); loadStats(); }
                else { alert("القاعدة فارغة."); }
            } 
        };
    </script>
</body>
</html>
