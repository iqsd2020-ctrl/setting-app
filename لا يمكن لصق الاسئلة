<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·ÙˆØ± - ÙˆØ­ÙŠ Ø£Ù‡Ù„ Ø§Ù„Ø¨ÙŠØª (Ø¹)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Reem+Kufi:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <style>
        /* Base Styles */
        body { font-family: 'Amiri', serif; background: #0f172a; color: #f1f5f9; min-height: 100vh; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); border-radius: 1rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .input-box { width: 100%; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: white; padding: 0.7rem; border-radius: 0.5rem; outline: none; transition: 0.3s; font-size: 0.95rem; }
        .input-box:focus { border-color: #d97706; box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.15); background: rgba(15, 23, 42, 1); }
        .input-box:disabled { opacity: 0.6; cursor: not-allowed; background: #1e293b; }
        select.input-box { appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23fbbf24' stroke-width='2' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: left 0.75rem center; background-repeat: no-repeat; background-size: 1.25em; }
        .btn-gold { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color: white; font-weight: bold; padding: 0.75rem; border-radius: 0.5rem; transition: 0.3s; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.25); border: 1px solid #d97706; }
        .btn-gold:hover { filter: brightness(1.15); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(217, 119, 6, 0.4); }
        .nav-item { padding: 1rem; color: #94a3b8; cursor: pointer; border-right: 3px solid transparent; transition: 0.3s; display: flex; align-items: center; gap: 0.75rem; font-family: 'Reem Kufi', sans-serif; }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-item.active { background: linear-gradient(90deg, rgba(217, 119, 6, 0.15), transparent); color: #fbbf24; border-right-color: #fbbf24; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: #1e293b; width: 95%; max-width: 650px; border-radius: 1rem; padding: 1.5rem; border: 1px solid #475569; transform: scale(0.95) translateY(10px); transition: 0.3s; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }
        .admin-item { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.05); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .admin-item:hover { border-color: #fbbf24; background: rgba(30, 41, 59, 0.8); transform: translateX(-4px); }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #0f172a; } ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #d97706; }
        .spinner { animation: spin 1s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex items-center justify-center text-right selection:bg-amber-500 selection:text-white">

    <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#0f172a] bg-[url('https://www.transparenttextures.com/patterns/arabesque.png')]">
        <div class="glass p-8 md:p-10 text-center w-full max-w-sm md:max-w-md border border-amber-500/30 relative overflow-hidden shadow-2xl">
            <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-amber-500/20 to-transparent rounded-bl-full"></div>
            <span class="material-symbols-rounded text-6xl text-amber-500 mb-6 drop-shadow-lg block">admin_panel_settings</span>
            <h1 class="text-3xl font-bold text-white mb-2 font-[Reem_Kufi]">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆØ±</h1>
            <p class="text-slate-400 text-sm mb-8">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙˆØ­ÙŠ Ø£Ù‡Ù„ Ø§Ù„Ø¨ÙŠØª (Ø¹)</p>
            <div class="relative group">
                <input type="password" id="admin-pin" class="input-box text-center text-3xl tracking-[0.5em] bg-black/40 border-slate-600 h-16 font-mono text-amber-500 placeholder-slate-700 mb-6 group-hover:border-amber-500/50" placeholder="â€¢â€¢â€¢â€¢" maxlength="4" inputmode="numeric" pattern="[0-9]*">
            </div>
            <button id="btn-login" class="btn-gold w-full shadow-lg flex items-center justify-center gap-2 text-lg"><span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span> <span class="material-symbols-rounded">login</span></button>
            <p id="login-msg" class="text-red-400 text-sm mt-4 h-5 font-bold transition-all"></p>
        </div>
    </div>

    <div id="dashboard-container" class="hidden w-full h-screen flex overflow-hidden">
        
        <div class="w-20 md:w-72 bg-[#1e293b] border-l border-slate-700 flex flex-col hidden md:flex shadow-2xl z-20 relative transition-all duration-300">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-500 to-amber-700"></div>
            <div class="p-4 md:p-8 text-center border-b border-slate-700 bg-slate-900/30">
                <h2 class="text-amber-500 font-bold text-lg md:text-2xl font-[Reem_Kufi] drop-shadow-md">Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</h2>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 md:py-6 space-y-1">
                <div class="nav-item active" data-tab="view-dashboard"><span class="material-symbols-rounded text-xl">analytics</span> <span class="hidden md:inline">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</span></div>
                <div class="nav-item" data-tab="view-reports"><span class="material-symbols-rounded text-xl text-red-400">report_problem</span> <span class="hidden md:inline">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</span></div>
                <div class="nav-item" data-tab="view-users"><span class="material-symbols-rounded text-xl">manage_accounts</span> <span class="hidden md:inline">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span></div>
                <div class="nav-item" data-tab="view-content"><span class="material-symbols-rounded text-xl">post_add</span> <span class="hidden md:inline">Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰</span></div>
                <div class="nav-item" data-tab="view-manage"><span class="material-symbols-rounded text-xl">library_books</span> <span class="hidden md:inline">Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span></div>
                <div class="nav-item" data-tab="view-system"><span class="material-symbols-rounded text-xl">settings_applications</span> <span class="hidden md:inline">Ø§Ù„Ù†Ø¸Ø§Ù…</span></div>
            </nav>
            <div class="p-4 md:p-6 border-t border-slate-700 bg-slate-900/30">
                <button onclick="location.reload()" class="w-full flex items-center justify-center gap-3 text-red-400 hover:text-red-200 hover:bg-red-500/10 p-2 md:p-3 rounded-lg transition text-sm font-bold border border-transparent hover:border-red-500/30">
                    <span class="material-symbols-rounded">power_settings_new</span> <span class="hidden md:inline">Ø®Ø±ÙˆØ¬</span>
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-[#0f172a] h-full relative">
            
            <div class="md:hidden bg-[#1e293b] p-4 flex justify-between items-center border-b border-slate-700 shadow-md z-30 sticky top-0">
                <h2 class="text-amber-500 font-bold font-[Reem_Kufi] text-lg">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                <button class="text-slate-300 hover:text-white p-2 rounded-lg active:bg-slate-700" onclick="document.querySelector('.mobile-nav').classList.toggle('hidden')">
                    <span class="material-symbols-rounded text-2xl">menu</span>
                </button>
            </div>
            
            <div class="mobile-nav hidden md:hidden bg-slate-800/95 backdrop-blur-md border-b border-slate-700 p-2 grid grid-cols-6 gap-1 text-center shadow-xl z-20 absolute top-[60px] w-full">
                <button class="p-2 text-slate-400 hover:text-amber-500 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-dashboard')"><span class="material-symbols-rounded">analytics</span><span class="text-[9px]">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
                <button class="p-2 text-slate-400 hover:text-red-400 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-reports')"><span class="material-symbols-rounded">report_problem</span><span class="text-[9px]">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</span></button>
                <button class="p-2 text-slate-400 hover:text-amber-500 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-users')"><span class="material-symbols-rounded">group</span><span class="text-[9px]">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span></button>
                <button class="p-2 text-slate-400 hover:text-amber-500 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-content')"><span class="material-symbols-rounded">add</span><span class="text-[9px]">Ø¥Ø¶Ø§ÙØ©</span></button>
                <button class="p-2 text-slate-400 hover:text-amber-500 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-manage')"><span class="material-symbols-rounded">list</span><span class="text-[9px]">Ø§Ù„Ø¨Ù†Ùƒ</span></button>
                <button class="p-2 text-slate-400 hover:text-amber-500 rounded-lg hover:bg-slate-700/50 transition flex flex-col items-center gap-1" onclick="triggerTab('view-system')"><span class="material-symbols-rounded">settings</span><span class="text-[9px]">Ø§Ù„Ù†Ø¸Ø§Ù…</span></button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth" id="main-view-area">
                
                <div id="view-dashboard" class="view-section space-y-4 md:space-y-8 fade-in">
                    <h3 class="text-xl md:text-2xl text-white font-bold border-b border-slate-700 pb-3 flex items-center gap-3">
                        <span class="material-symbols-rounded text-amber-500 bg-amber-500/10 p-2 rounded-lg">dashboard</span> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
                    </h3>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-5">
                        <div class="glass p-4 text-center border-t-4 border-red-500 bg-red-900/10">
                            <span class="material-symbols-rounded text-3xl text-red-400 mb-2">report</span>
                            <div class="text-3xl font-bold text-white font-mono" id="dash-reports-count">-</div>
                            <div class="text-xs text-slate-400 mt-1 font-bold uppercase">Ø¨Ù„Ø§ØºØ§Øª Ù…Ø¹Ù„Ù‚Ø©</div>
                        </div>
                        <div class="glass p-4 text-center border-t-4 border-blue-500">
                            <span class="material-symbols-rounded text-3xl text-blue-400 mb-2">group</span>
                            <div class="text-3xl font-bold text-white font-mono" id="dash-users-count">-</div>
                            <div class="text-xs text-slate-400 mt-1 font-bold uppercase">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                        </div>
                        <div class="glass p-4 text-center border-t-4 border-green-500">
                            <span class="material-symbols-rounded text-3xl text-green-400 mb-2">quiz</span>
                            <div class="text-3xl font-bold text-white font-mono" id="dash-questions-count">-</div>
                            <div class="text-xs text-slate-400 mt-1 font-bold uppercase">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                        </div>
                        <div class="glass p-4 text-center border-t-4 border-purple-500">
                            <span class="material-symbols-rounded text-3xl text-purple-400 mb-2">category</span>
                            <div class="text-3xl font-bold text-white font-mono" id="dash-topics-count">-</div>
                            <div class="text-xs text-slate-400 mt-1 font-bold uppercase">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</div>
                        </div>
                    </div>
                    
                    <div class="glass p-4 md:p-6 mt-4 md:mt-6 border border-slate-700/50">
                        <div class="flex justify-between items-center mb-3 md:mb-4">
                            <h4 class="text-lg md:text-xl text-white font-bold flex items-center gap-2"><span class="material-symbols-rounded">pie_chart</span> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h4>
                            <select id="chart-filter" class="input-box text-xs w-40 py-1 bg-slate-900/50 border-slate-600">
                                <option value="main">Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
                            </select>
                        </div>
                        <div class="h-64 w-full flex justify-center"><canvas id="questionsChart"></canvas></div>
                    </div>
                </div>

                <div id="view-reports" class="view-section hidden space-y-4 fade-in">
                    <div class="flex justify-between items-center bg-red-900/20 p-4 rounded-xl border border-red-700/30">
                        <h3 class="text-lg md:text-xl text-white font-bold flex items-center gap-3">
                            <span class="material-symbols-rounded text-red-400 bg-red-400/10 p-2 rounded-lg">report_problem</span>
                            Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                        </h3>
                        <button id="btn-refresh-reports" class="bg-slate-700 text-white p-2 rounded-lg hover:bg-slate-600 transition"><span class="material-symbols-rounded">sync</span></button>
                    </div>
                    <div id="reports-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
                </div>

                <div id="view-users" class="view-section hidden space-y-4 fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-800/40 p-4 rounded-xl border border-slate-700/50">
                        <h3 class="text-lg md:text-xl text-white font-bold flex items-center gap-3">
                            <span class="material-symbols-rounded text-blue-400 bg-blue-400/10 p-2 rounded-lg">people_alt</span> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                        </h3>
                        <div class="flex gap-3 w-full md:w-auto">
                            <div class="relative w-full md:w-72">
                                <span class="material-symbols-rounded absolute right-3 top-2.5 text-slate-500 pointer-events-none">search</span>
                                <input type="text" id="user-search" placeholder="Ø¨Ø­Ø«..." class="input-box pr-10 py-2 text-sm bg-slate-900/50">
                            </div>
                            <button id="btn-refresh-users" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"><span class="material-symbols-rounded">sync</span></button>
                        </div>
                    </div>
                    <div id="users-grid" class="grid grid-cols-1 gap-3"></div>
                </div>

                <div id="view-content" class="view-section hidden space-y-4 md:space-y-8 fade-in">
                    <h3 class="text-xl text-white font-bold border-b border-slate-700 pb-3 flex items-center gap-3"><span class="material-symbols-rounded text-green-500 bg-green-500/10 p-2 rounded-lg">add_circle</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass p-6 border-t-4 border-green-500 lg:col-span-2">
                            <h4 class="text-lg text-green-400 font-bold mb-4 flex items-center gap-2"><span class="material-symbols-rounded">edit_square</span> Ù…Ø­Ø±Ø± ÙŠØ¯ÙˆÙŠ</h4>
                            <div class="space-y-4">
                                <input id="man-q" type="text" class="input-box text-lg font-bold bg-slate-800" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„...">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div class="flex gap-2 bg-slate-800/50 p-2 rounded border border-slate-700"><input type="radio" name="correct_ans_selector" value="0" checked class="accent-green-500"><input id="man-o1" type="text" class="bg-transparent text-white w-full outline-none text-sm" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 1"></div>
                                    <div class="flex gap-2 bg-slate-800/50 p-2 rounded border border-slate-700"><input type="radio" name="correct_ans_selector" value="1" class="accent-green-500"><input id="man-o2" type="text" class="bg-transparent text-white w-full outline-none text-sm" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 2"></div>
                                    <div class="flex gap-2 bg-slate-800/50 p-2 rounded border border-slate-700"><input type="radio" name="correct_ans_selector" value="2" class="accent-green-500"><input id="man-o3" type="text" class="bg-transparent text-white w-full outline-none text-sm" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 3"></div>
                                    <div class="flex gap-2 bg-slate-800/50 p-2 rounded border border-slate-700"><input type="radio" name="correct_ans_selector" value="3" class="accent-green-500"><input id="man-o4" type="text" class="bg-transparent text-white w-full outline-none text-sm" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 4"></div>
                                </div>
                                <textarea id="man-exp" class="input-box h-16 text-sm resize-none" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©..."></textarea>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <select id="man-cat" class="input-box text-xs"></select>
                                    <select id="man-topic" class="input-box text-xs" disabled></select>
                                    <select id="man-diff" class="input-box text-xs"><option value="Ù…ÙˆØ­Ø¯">Ù…ÙˆØ­Ø¯</option></select>
                                    <button id="btn-man-save" class="btn-gold text-sm font-bold">Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                                </div>
                            </div>
                        </div>

                        <div class="glass p-6 border-t-4 border-blue-500">
                            <h4 class="text-lg text-blue-400 font-bold mb-4 flex items-center gap-2"><span class="material-symbols-rounded">cloud_upload</span> Ø±ÙØ¹ Ù…Ù„Ù JSON</h4>
                            <div class="grid grid-cols-1 gap-4 mb-4">
                                <select id="upload-cat" class="input-box text-sm"></select>
                                <select id="upload-topic" class="input-box text-sm" disabled></select>
                            </div>
                            <div class="flex gap-4 items-center">
                                <input type="file" id="json-file-input" accept=".json" class="text-sm text-slate-400 w-full file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
                                <button id="btn-upload-file" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold w-32">Ø±ÙØ¹</button>
                            </div>
                        </div>

                        <div class="glass p-6 border-t-4 border-purple-500">
                            <h4 class="text-lg text-purple-400 font-bold mb-4 flex items-center gap-2"><span class="material-symbols-rounded">content_paste</span> Ù„ØµÙ‚ ÙƒÙˆØ¯ JSON</h4>
                            <div class="grid grid-cols-1 gap-4 mb-4">
                                <select id="paste-cat" class="input-box text-sm"></select>
                                <select id="paste-topic" class="input-box text-sm" disabled></select>
                            </div>
                            <textarea id="json-paste-area" class="input-box h-24 text-xs font-mono mb-4 bg-slate-900/50" dir="ltr" placeholder='[{"question":"...","options":[...],"correctAnswer":0}]'></textarea>
                            <button id="btn-paste-upload" class="bg-purple-600 text-white w-full py-2 rounded-lg hover:bg-purple-700 font-bold">Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¥Ø¶Ø§ÙØ©</button>
                        </div>
                    </div>
                </div>

                <div id="view-manage" class="view-section hidden space-y-4 fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-800/40 p-4 rounded-xl border border-slate-700/50">
                        <h3 class="text-lg text-white font-bold flex items-center gap-3"><span class="material-symbols-rounded text-purple-400 bg-purple-400/10 p-2 rounded-lg">library_books</span> Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© <span id="qs-counter" class="text-xs bg-slate-700 px-2 py-1 rounded-full">0</span></h3>
                        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                            <input type="text" id="qs-search-input" placeholder="Ø¨Ø­Ø«..." class="input-box py-2 text-sm bg-slate-900/50 flex-1">
                            
                            <div class="flex gap-2">
                                <select id="manage-cat-filter" class="input-box text-sm w-32 bg-slate-900/50 border-slate-600"><option value="">Ø§Ù„ØªØµÙ†ÙŠÙ</option></select>
                                <select id="manage-topic-filter" class="input-box text-sm w-48 bg-slate-900/50 border-slate-600" disabled><option value="">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</option></select>
                            </div>

                            <button id="btn-refresh-qs" class="bg-slate-600 text-white px-3 rounded-lg hover:bg-slate-500"><span class="material-symbols-rounded">sync</span></button>
                        </div>
                    </div>
                    <div class="bg-slate-800/20 rounded-xl p-2 min-h-[400px]">
                        <div id="questions-grid" class="space-y-3 mb-4"></div>
                        <button id="btn-load-more" class="hidden w-full py-3 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-lg border border-dashed border-slate-600 font-bold text-sm">Ø§Ù„Ù…Ø²ÙŠØ¯</button>
                    </div>
                </div>

                <div id="view-system" class="view-section hidden space-y-4 fade-in">
                    <h3 class="text-xl text-white font-bold border-b border-slate-700 pb-3 flex items-center gap-3"><span class="material-symbols-rounded text-slate-400 bg-slate-700/30 p-2 rounded-lg">settings</span> Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                    <div class="glass p-6 space-y-5 border-r-4 border-r-green-500">
                        <h4 class="text-lg text-green-400 font-bold"><span class="material-symbols-rounded">download</span> ØªØµØ¯ÙŠØ± Ù…Ø®ØµØµ</h4>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <select id="export-cat" class="input-box text-xs"></select>
                            <select id="export-topic" class="input-box text-xs" disabled></select>
                            <div class="col-span-2"><button id="btn-export-filtered" class="bg-green-600 hover:bg-green-700 text-white w-full py-2 rounded-lg text-sm font-bold" disabled>ØªØµØ¯ÙŠØ± JSON</button></div>
                        </div>
                    </div>
                    <div class="glass p-6 flex justify-between items-center border-r-4 border-r-blue-500">
                        <div><h4 class="text-white font-bold">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙƒØ§Ù…Ù„</h4><p class="text-xs text-slate-400">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p></div>
                        <button id="btn-backup" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold text-sm">ØªØµØ¯ÙŠØ±</button>
                    </div>
                    <div class="glass p-6 flex justify-between items-center border-r-4 border-r-red-600 bg-red-900/10">
                        <div><h4 class="text-red-400 font-bold">Ø­Ø°Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙ‚Ø·</h4><p class="text-xs text-slate-400">ØªØµÙÙŠØ± Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p></div>
                        <button id="btn-nuke" class="bg-red-900 hover:bg-red-800 text-white px-6 py-2 rounded-lg font-bold text-sm border border-red-700">ØªÙ†ÙÙŠØ°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="user-edit-modal" class="modal-overlay">
        <div class="modal-content p-6">
            <h3 class="text-lg font-bold text-amber-500 mb-4">ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…</h3>
            <div class="flex flex-col items-center mb-4 gap-2">
                <div id="edit-avatar-preview" class="w-24 h-24 rounded-full bg-slate-700 flex items-center justify-center text-3xl border-2 border-amber-500 overflow-hidden"></div>
                <div class="flex gap-2">
                    <label class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded cursor-pointer">
                        Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                        <input type="file" id="upload-new-avatar" accept="image/*" class="hidden">
                    </label>
                    <button id="btn-del-avatar" class="text-xs bg-red-600/30 hover:bg-red-600/50 text-red-300 px-3 py-1 rounded">Ø­Ø°Ù</button>
                </div>
            </div>
            <div class="space-y-4">
                <div><label class="text-xs text-slate-400">Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="edit-name" class="input-box"></div>
                <div><label class="text-xs text-slate-400">Ø§Ù„Ù†Ù‚Ø§Ø·</label><input type="number" id="edit-score" class="input-box"></div>
                <div><label class="text-xs text-slate-400">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="text" id="edit-pass" class="input-box" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ±"></div>
                <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="edit-banned" class="w-5 h-5 accent-red-500"><span class="text-slate-300 text-sm">Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨</span></label>
                <div class="flex gap-3 mt-4"><button id="btn-save-user" class="btn-gold flex-1">Ø­ÙØ¸</button><button onclick="document.getElementById('user-edit-modal').classList.remove('active')" class="bg-slate-700 text-white px-4 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button></div>
            </div>
        </div>
    </div>

    <div id="question-edit-modal" class="modal-overlay">
        <div class="modal-content p-6 border-t-4 border-blue-500">
            <div class="flex justify-between mb-4"><h3 class="text-lg font-bold text-blue-500">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„</h3><button class="close-q-modal text-slate-400">âœ•</button></div>
            <div class="space-y-3">
                <input id="edit-q-text" type="text" class="input-box font-bold bg-slate-800">
                <div class="grid grid-cols-2 gap-2">
                    <div class="flex gap-2 bg-slate-800/50 p-2 rounded border border-slate-700"><input type="radio" name="edit_ans_selector" value="0" class="accent-blue-500"><input id="edit-o1" type="text" class="bg-transparent text-white w-full outline-none text-xs"></div>
                    <div class="flex gap-2 bg-slate-800/50 p-2 rounded border border-slate-700"><input type="radio" name="edit_ans_selector" value="1" class="accent-blue-500"><input id="edit-o2" type="text" class="bg-transparent text-white w-full outline-none text-xs"></div>
                    <div class="flex gap-2 bg-slate-800/50 p-2 rounded border border-slate-700"><input type="radio" name="edit_ans_selector" value="2" class="accent-blue-500"><input id="edit-o3" type="text" class="bg-transparent text-white w-full outline-none text-xs"></div>
                    <div class="flex gap-2 bg-slate-800/50 p-2 rounded border border-slate-700"><input type="radio" name="edit_ans_selector" value="3" class="accent-blue-500"><input id="edit-o4" type="text" class="bg-transparent text-white w-full outline-none text-xs"></div>
                </div>
                <textarea id="edit-q-exp" class="input-box h-16 text-sm resize-none bg-slate-800"></textarea>
                <div class="grid grid-cols-2 gap-2">
                    <select id="edit-q-cat" class="input-box text-xs"></select><select id="edit-q-topic" class="input-box text-xs"></select>
                </div>
                <button id="btn-save-edit-q" class="bg-blue-600 text-white w-full py-3 rounded-lg font-bold shadow-lg">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900/95 text-white px-8 py-4 rounded-2xl shadow-2xl border border-amber-500/40 hidden z-[80] flex items-center gap-4 transition-all duration-300 backdrop-blur-md min-w-[320px] justify-center">
        <span class="material-symbols-rounded text-amber-500 text-2xl" id="toast-icon">check_circle</span><span id="toast-msg" class="text-sm font-bold"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, addDoc, query, where, orderBy, limit, serverTimestamp, writeBatch, startAfter } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Firebase Config (Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£ØµÙ„ÙŠ)
        const app = initializeApp({ apiKey: "AIzaSyDY1FNxvECtaV_dflCzkRH4pHQi_HQ4fwA", authDomain: "all-in-b0422.firebaseapp.com", projectId: "all-in-b0422", storageBucket: "all-in-b0422.firebasestorage.app", messagingSenderId: "347315641241", appId: "1:347315641241:web:c9ed240a00e5d2c5031108" });
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let isAuthReady = false;
        signInAnonymously(auth).then(() => { isAuthReady = true; console.log("Admin Auth Ready"); }).catch(e => console.error(e));

        // Helper Funcs
        const el = (id) => document.getElementById(id);
        const show = (id) => el(id).classList.remove('hidden');
        const hide = (id) => el(id).classList.add('hidden');
        const toast = (msg, icon = 'check_circle') => { el('toast-msg').innerText = msg; el('toast-icon').innerText = icon; const t = el('toast'); t.classList.remove('hidden'); t.classList.add('flex'); t.style.opacity = "1"; t.style.transform = "translate(-50%, 0)"; setTimeout(() => { t.style.opacity = "0"; t.style.transform = "translate(-50%, 20px)"; setTimeout(() => { t.classList.add('hidden'); t.classList.remove('flex'); }, 300); }, 3000); };

        // New Expanded Data
        const topics = {"Ø§Ù„Ù…Ø¹ØµÙˆÙ…ÙˆÙ† (Ø¹Ù„ÙŠÙ‡Ù… Ø§Ù„Ø³Ù„Ø§Ù…)":["Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ Ù…Ø­Ù…Ø¯ (Øµ)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ (Ø¹)","Ø§Ù„Ø³ÙŠØ¯Ø© ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø­Ø³Ù† Ø§Ù„Ù…Ø¬ØªØ¨Ù‰ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø­Ø³ÙŠÙ† (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø³Ø¬Ø§Ø¯ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¨Ø§Ù‚Ø± (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„ØµØ§Ø¯Ù‚ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ø¸Ù… (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø±Ø¶Ø§ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù‡Ø§Ø¯ÙŠ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ (Ø¹)","Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù…Ù‡Ø¯ÙŠ (Ø¹Ø¬)"],"Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡ ÙˆØ§Ù„Ø±Ø³Ù„":["Ø£ÙˆÙ„Ùˆ Ø§Ù„Ø¹Ø²Ù… Ù…Ù† Ø§Ù„Ø±Ø³Ù„","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ Ø¢Ø¯Ù… (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ Ù†ÙˆØ­ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ Ù…ÙˆØ³Ù‰ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ Ø¹ÙŠØ³Ù‰ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ ÙŠÙˆØ³Ù (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ Ø³Ù„ÙŠÙ…Ø§Ù† (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ Ø¯Ø§ÙˆØ¯ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ ÙŠÙˆÙ†Ø³ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ Ø²ÙƒØ±ÙŠØ§ ÙˆÙŠØ­ÙŠÙ‰ (Ø¹)","Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙŠ Ø£ÙŠÙˆØ¨ (Ø¹)","Ù‚ØµØµ Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡ ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†"],"Ø´Ø®ØµÙŠØ§Øª (Ø£ØµØ­Ø§Ø¨ ÙˆØ¹Ù„Ù…Ø§Ø¡)":["Ø§Ù„Ø³ÙŠØ¯Ø© Ø®Ø¯ÙŠØ¬Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰ (Ø¹)","Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ (Ø¹)","Ø§Ù„Ø³ÙŠØ¯Ø© Ø£Ù… Ø§Ù„Ø¨Ù†ÙŠÙ† (Ø¹)","Ø§Ù„Ø³ÙŠØ¯Ø© Ø±Ù‚ÙŠØ© Ø¨Ù†Øª Ø§Ù„Ø­Ø³ÙŠÙ† (Ø¹)","Ø£Ø¨Ùˆ Ø§Ù„ÙØ¶Ù„ Ø§Ù„Ø¹Ø¨Ø§Ø³ (Ø¹)","Ø¹Ù„ÙŠ Ø§Ù„Ø£ÙƒØ¨Ø± (Ø¹)","Ø§Ù„Ù‚Ø§Ø³Ù… Ø¨Ù† Ø§Ù„Ø­Ø³Ù† (Ø¹)","Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠ","Ø£Ø¨Ùˆ Ø°Ø± Ø§Ù„ØºÙØ§Ø±ÙŠ","Ø§Ù„Ø³ÙŠØ¯ Ù…Ø­Ù…Ø¯ Ø§Ù„ØµØ¯Ø±","Ø§Ù„Ù…Ù‚Ø¯Ø§Ø¯ Ø¨Ù† Ø§Ù„Ø£Ø³ÙˆØ¯","Ø¹Ù…Ø§Ø± Ø¨Ù† ÙŠØ§Ø³Ø±","Ù…Ø§Ù„Ùƒ Ø§Ù„Ø£Ø´ØªØ±","Ù…Ø³Ù„Ù… Ø¨Ù† Ø¹Ù‚ÙŠÙ„ (Ø¹)","Ø§Ù„Ù…Ø®ØªØ§Ø± Ø§Ù„Ø«Ù‚ÙÙŠ","Ø­Ø¨ÙŠØ¨ Ø¨Ù† Ù…Ø¸Ø§Ù‡Ø± Ø§Ù„Ø£Ø³Ø¯ÙŠ","Ù…ÙŠØ«Ù… Ø§Ù„ØªÙ…Ø§Ø±","ÙƒÙ…ÙŠÙ„ Ø¨Ù† Ø²ÙŠØ§Ø¯","Ù‡Ø§Ù†ÙŠ Ø¨Ù† Ø¹Ø±ÙˆØ©","Ø§Ù„Ø´ÙŠØ® Ø§Ù„Ù…ÙÙŠØ¯","Ø§Ù„Ø´ÙŠØ® Ø§Ù„Ø·ÙˆØ³ÙŠ"],"Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆÙ†Ù‡Ø¬ Ø§Ù„Ø¨Ù„Ø§ØºØ©":["Ù…Ø¹Ø§Ù†ÙŠ Ù…ÙØ±Ø¯Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†","Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù†Ø²ÙˆÙ„","Ø§Ù„Ù†Ø§Ø³Ø® ÙˆØ§Ù„Ù…Ù†Ø³ÙˆØ®","Ø§Ù„Ø£Ù…Ø«Ø§Ù„ ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†","Ø§Ù„Ø®Ø·Ø¨Ø© Ø§Ù„Ø´Ù‚Ø´Ù‚ÙŠØ©","Ø®Ø·Ø¨Ø© Ø§Ù„Ù…ØªÙ‚ÙŠÙ†","Ø¹Ù‡Ø¯ Ø§Ù„Ø¥Ù…Ø§Ù… Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø£Ø´ØªØ±","Ø­ÙƒÙ… ÙˆÙ…ÙˆØ§Ø¹Ø¸ Ù†Ù‡Ø¬ Ø§Ù„Ø¨Ù„Ø§ØºØ©","Ø§Ù„ØµØ­ÙŠÙØ© Ø§Ù„Ø³Ø¬Ø§Ø¯ÙŠØ©"],"Ø¹Ù‚Ø§Ø¦Ø¯ ÙˆÙÙ‚Ù‡":["Ø£ØµÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„ØªÙˆØ­ÙŠØ¯ ÙˆØµÙØ§Øª Ø§Ù„Ù„Ù‡","Ø§Ù„Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù„Ù‡ÙŠ","Ø§Ù„Ù†Ø¨ÙˆØ©","Ø§Ù„Ø¥Ù…Ø§Ù…Ø© ÙˆØ§Ù„ÙˆÙ„Ø§ÙŠØ©","Ø¹Ø§Ù„Ù… Ø§Ù„Ø¨Ø±Ø²Ø®","Ø§Ù„Ù…Ø¹Ø§Ø¯ ÙˆÙŠÙˆÙ… Ø§Ù„Ù‚ÙŠØ§Ù…Ø©","Ø§Ù„Ø´ÙØ§Ø¹Ø©","Ø§Ù„Ø±Ø¬Ø¹Ø©","Ø§Ù„Ø¨Ø¯Ø§Ø¡","ÙØ±ÙˆØ¹ Ø§Ù„Ø¯ÙŠÙ†","Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØµÙ„Ø§Ø©","Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØµÙˆÙ…","Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø®Ù…Ø³","Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø­Ø¬ ÙˆØ§Ù„Ø¹Ù…Ø±Ø©","Ø§Ù„Ø£Ù…Ø± Ø¨Ø§Ù„Ù…Ø¹Ø±ÙˆÙ ÙˆØ§Ù„Ù†Ù‡ÙŠ Ø¹Ù† Ø§Ù„Ù…Ù†ÙƒØ±","Ø§Ù„Ø·Ù‡Ø§Ø±Ø© ÙˆØ§Ù„Ù†Ø¬Ø§Ø³Ø§Øª"],"Ø§Ù„Ø«Ù‚Ø§ÙØ© Ø§Ù„Ù…Ù‡Ø¯ÙˆÙŠØ©":["Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­ØªÙ…ÙŠØ©","Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ± ØºÙŠØ± Ø§Ù„Ø­ØªÙ…ÙŠØ©","Ø§Ù„Ø³ÙØ±Ø§Ø¡ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©","Ø§Ù„ØºÙŠØ¨Ø© Ø§Ù„ØµØºØ±Ù‰","Ø§Ù„ØºÙŠØ¨Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ†","Ø£ØµØ­Ø§Ø¨ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù…Ù‡Ø¯ÙŠ","Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù„Ù‡ÙŠ"],"ØªØ§Ø±ÙŠØ® ÙˆÙ…Ø¹Ø§Ø±Ùƒ":["Ø§Ù„Ù‡Ø¬Ø±Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ©","Ù…Ø¹Ø±ÙƒØ© Ø¨Ø¯Ø± Ø§Ù„ÙƒØ¨Ø±Ù‰","Ù…Ø¹Ø±ÙƒØ© Ø£Ø­Ø¯","Ù…Ø¹Ø±ÙƒØ© Ø§Ù„Ø®Ù†Ø¯Ù‚ (Ø§Ù„Ø£Ø­Ø²Ø§Ø¨)","Ù…Ø¹Ø±ÙƒØ© Ø®ÙŠØ¨Ø±","ÙØªØ­ Ù…ÙƒØ©","Ù…Ø¹Ø±ÙƒØ© Ø­Ù†ÙŠÙ†","Ø­Ø±ÙˆØ¨ Ø§Ù„Ø±Ø¯Ø©","Ø­Ø±Ø¨ Ø§Ù„Ø¬Ù…Ù„","Ù…Ø¹Ø±ÙƒØ© ØµÙÙŠÙ†","Ù…Ø¹Ø±ÙƒØ© Ø§Ù„Ù†Ù‡Ø±ÙˆØ§Ù†","ØµÙ„Ø­ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø­Ø³Ù† (Ø¹)","ÙˆØ§Ù‚Ø¹Ø© ÙƒØ±Ø¨Ù„Ø§Ø¡ (ØªÙØ§ØµÙŠÙ„)","ÙŠÙˆÙ… Ø§Ù„Ù…Ø¨Ø§Ù‡Ù„Ø©","Ø¹ÙŠØ¯ Ø§Ù„ØºØ¯ÙŠØ± Ø§Ù„Ø£ØºØ±","Ø­Ø¯ÙŠØ« Ø§Ù„ÙƒØ³Ø§Ø¡ (Ø§Ù„Ø­Ø¯Ø«)","ÙØ§Ø¬Ø¹Ø© Ù‡Ø¯Ù… Ø§Ù„Ø¨Ù‚ÙŠØ¹"],"Ø£Ø¯Ø¹ÙŠØ© ÙˆØ²ÙŠØ§Ø±Ø§Øª":["Ø¯Ø¹Ø§Ø¡ ÙƒÙ…ÙŠÙ„","Ø¯Ø¹Ø§Ø¡ Ø§Ù„ØµØ¨Ø§Ø­","Ø¯Ø¹Ø§Ø¡ Ø§Ù„ØªÙˆØ³Ù„","Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø¹Ù‡Ø¯","Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ù†Ø¯Ø¨Ø©","Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø§ÙØªØªØ§Ø­","Ø¯Ø¹Ø§Ø¡ Ø£Ø¨ÙŠ Ø­Ù…Ø²Ø© Ø§Ù„Ø«Ù…Ø§Ù„ÙŠ","Ø¯Ø¹Ø§Ø¡ Ø¹Ø±ÙØ©","Ø§Ù„Ù…Ù†Ø§Ø¬Ø§Ø© Ø§Ù„Ø´Ø¹Ø¨Ø§Ù†ÙŠØ©","Ø²ÙŠØ§Ø±Ø© Ø¹Ø§Ø´ÙˆØ±Ø§Ø¡","Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ†","Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©","Ø²ÙŠØ§Ø±Ø© ÙˆØ§Ø±Ø«","Ø²ÙŠØ§Ø±Ø© Ø¢Ù„ ÙŠØ³","Ø²ÙŠØ§Ø±Ø© Ø£Ù…ÙŠÙ† Ø§Ù„Ù„Ù‡"]};

        // Login (inputmode="numeric")
        el('btn-login').onclick = () => {
            if(!isAuthReady) return el('login-msg').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
            // Add logic to prevent non-numeric (extra safety)
            const pin = el('admin-pin').value.replace(/[^0-9]/g, '');
            if(pin === '0000') { hide('login-screen'); show('dashboard-container'); loadStats(); } 
            else { el('login-msg').innerText = "Ø±Ù…Ø² Ø®Ø§Ø·Ø¦"; setTimeout(()=>el('login-msg').innerText='', 2000); }
        };
        el('admin-pin').addEventListener('input', function (e) { this.value = this.value.replace(/[^0-9]/g, ''); });

        // Navigation
        window.triggerTab = (tabId) => {
            document.querySelectorAll('.nav-item').forEach(b => { b.classList.remove('active'); if(b.dataset.tab === tabId) b.classList.add('active'); });
            document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
            show(tabId);
            if(tabId === 'view-users') loadUsers();
            if(tabId === 'view-reports') loadReports();
            if(tabId === 'view-manage') { el('qs-search-input').value=''; loadQuestions(false); }
            if(tabId === 'view-dashboard') loadStats();
            document.querySelector('.mobile-nav').classList.add('hidden');
        };
        document.querySelectorAll('.nav-item').forEach(btn => btn.onclick = () => triggerTab(btn.dataset.tab));

        // Dropdowns
        const initDrops = (cId, tId) => {
            const c = el(cId), t = el(tId);
            c.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ --</option>'; Object.keys(topics).forEach(k => c.add(new Option(k, k)));
            c.onchange = () => { t.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ --</option>'; if(topics[c.value]) { t.disabled = false; topics[c.value].forEach(sub => t.add(new Option(sub, sub))); } else t.disabled = true; if(cId=='export-cat') checkExportBtn(); };
        };
        initDrops('upload-cat', 'upload-topic'); initDrops('man-cat', 'man-topic'); initDrops('paste-cat', 'paste-topic'); initDrops('edit-q-cat', 'edit-q-topic'); initDrops('export-cat', 'export-topic');
        // New Manage Drops
        initDrops('manage-cat-filter', 'manage-topic-filter');

        // Stats & Chart (AGGREGATED + Filter)
        let myChart = null;
        let cachedQuestionsData = [];

        async function loadStats() {
            const qSnap = await getDocs(query(collection(db, "questions"))); 
            el('dash-questions-count').innerText = qSnap.size;
            
            cachedQuestionsData = []; // Cache for chart filtering
            qSnap.forEach(doc => cachedQuestionsData.push(doc.data()));

            const uSnap = await getDocs(query(collection(db, "users"))); el('dash-users-count').innerText = uSnap.size;
            const rSnap = await getDocs(query(collection(db, "reports"))); el('dash-reports-count').innerText = rSnap.size;
            el('dash-topics-count').innerText = Object.keys(topics).length;
            
            // Fill Chart Filter
            const chartFilter = el('chart-filter');
            chartFilter.innerHTML = '<option value="main">Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>';
            Object.keys(topics).forEach(k => chartFilter.add(new Option(k, k)));
            
            renderChart('main');
        }

        el('chart-filter').onchange = (e) => renderChart(e.target.value);

        function renderChart(mode) {
            const counts = {};
            
            cachedQuestionsData.forEach(q => {
                const t = q.topic || "ØºÙŠØ± Ù…ØµÙ†Ù";
                if (mode === 'main') {
                    let category = "ØºÙŠØ± Ù…ØµÙ†Ù";
                    for(const [cat, subs] of Object.entries(topics)) { if(subs.includes(t)) { category = cat; break; } }
                    counts[category] = (counts[category] || 0) + 1;
                } else {
                    // Filter specific category
                    if (topics[mode] && topics[mode].includes(t)) {
                         counts[t] = (counts[t] || 0) + 1;
                    }
                }
            });

            // Generate Colors
            const colors = [
                 '#d97706', '#2563eb', '#16a34a', '#dc2626', '#9333ea', '#0891b2',
                 '#f59e0b', '#3b82f6', '#22c55e', '#ef4444', '#a855f7', '#06b6d4'
            ];

            if(myChart) myChart.destroy();
            myChart = new Chart(el('questionsChart').getContext('2d'), {
                type: 'doughnut',
                data: { 
                    labels: Object.keys(counts), 
                    datasets: [{ 
                        data: Object.values(counts), 
                        backgroundColor: colors.slice(0, Object.keys(counts).length), 
                        borderWidth: 0 
                    }] 
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#cbd5e1', font: { family: 'Amiri' } } } } }
            });
        }

        // --- REPORTS SYSTEM ---
        el('btn-refresh-reports').onclick = loadReports;
        async function loadReports() {
            const grid = el('reports-grid');
            grid.innerHTML = '<div class="col-span-2 text-center text-slate-500 py-8"><span class="material-symbols-rounded spinner">sync</span></div>';
            try {
                const q = query(collection(db, "reports"), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                grid.innerHTML = '';
                if(snap.empty) { grid.innerHTML = '<div class="col-span-2 text-center text-slate-500 py-8 bg-slate-800/30 rounded-xl">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ø¬Ø¯ÙŠØ¯Ø© ğŸ‰</div>'; return; }

                snap.forEach(docSnap => {
                    const r = docSnap.data();
                    const date = r.timestamp ? new Date(r.timestamp.toDate()).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const div = document.createElement('div');
                    div.className = 'glass p-4 border-l-4 border-l-red-500 relative fade-in';
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div><span class="text-[10px] text-slate-400 uppercase">Ø¨Ù„Ø§Øº Ù…Ù†: ${r.reportedByUsername || 'Ù…Ø¬Ù‡ÙˆÙ„'}</span><div class="text-red-400 font-bold text-sm mt-1 flex items-center gap-1"><span class="material-symbols-rounded text-sm">calendar_today</span> ${date}</div></div>
                            <span class="bg-slate-800 text-slate-400 text-[10px] px-2 py-1 rounded font-mono">${docSnap.id.substring(0,6)}</span>
                        </div>
                        <div class="bg-slate-900/50 p-3 rounded mb-3 border border-slate-700/50"><div class="text-xs text-slate-500 mb-1">Ø§Ù„Ø³Ø¤Ø§Ù„:</div><p class="text-white text-sm font-bold leading-relaxed">"${r.questionText}"</p><div class="text-xs text-amber-500 mt-1">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ${r.topic}</div></div>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-xs font-bold btn-fix">ÙØ­Øµ ÙˆØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="bg-slate-700 hover:bg-slate-600 text-slate-300 py-2 rounded text-xs font-bold btn-dismiss">ØªØ¬Ø§Ù‡Ù„ ÙˆØ­Ø°Ù</button>
                            <button class="bg-red-900/50 hover:bg-red-900 text-red-400 border border-red-800 py-2 rounded text-xs font-bold btn-nuke-q">Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„!</button>
                        </div>
                    `;
                    div.querySelector('.btn-dismiss').onclick = async () => { if(confirm("Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº ÙÙ‚Ø·ØŸ")) { await deleteDoc(doc(db, "reports", docSnap.id)); div.remove(); toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº"); } };
                    div.querySelector('.btn-nuke-q').onclick = async () => { if(confirm("Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø¨Ù„Ø§Øº Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) { try { if(r.questionId !== 'N/A') await deleteDoc(doc(db, "questions", r.questionId)); await deleteDoc(doc(db, "reports", docSnap.id)); div.remove(); toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø¨Ù„Ø§Øº", "delete"); } catch(e) { alert(e.message); } } };
                    div.querySelector('.btn-fix').onclick = async () => {
                        if(r.questionId === 'N/A') return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ù„Ø³Ø¤Ø§Ù„");
                        const btn = div.querySelector('.btn-fix'); btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...";
                        try {
                            const qDoc = await getDoc(doc(db, "questions", r.questionId));
                            if(qDoc.exists()) { openEditQModal(r.questionId, qDoc.data()); } else { alert("Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø­Ø°ÙˆÙ Ù…Ø³Ø¨Ù‚Ø§Ù‹."); }
                        } catch(e) { alert("Ø®Ø·Ø£: " + e.message); }
                        btn.innerText = "ÙØ­Øµ ÙˆØªØ¹Ø¯ÙŠÙ„";
                    };
                    grid.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }

        // --- USERS ---
        async function loadUsers() {
            const grid = el('users-grid'); grid.innerHTML = '<div class="text-center py-8"><span class="material-symbols-rounded spinner text-amber-500">sync</span></div>';
            const term = el('user-search').value.toLowerCase();
            try {
                const snap = await getDocs(query(collection(db, "users"), orderBy("highScore", "desc"), limit(50)));
                grid.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data();
                    if(term && !u.username?.toLowerCase().includes(term)) return;
                    const div = document.createElement('div');
                    div.className = `admin-item ${u.isBanned?'border-red-500':''}`;
                    // Avatar Logic
                    let av = `<span class="material-symbols-rounded text-xl text-slate-400">person</span>`;
                    if(u.customAvatar) av = `<img src="${u.customAvatar}" class="w-full h-full object-cover">`;
                    else if(u.avatar) av = `<span class="material-symbols-rounded text-amber-500 text-xl">${u.avatar}</span>`;

                    div.innerHTML = `
                        <div class="flex items-center gap-3 w-full">
                            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center overflow-hidden border border-slate-600">${av}</div>
                            <div class="flex-1"><div class="font-bold text-white">${u.username||'Ø¶ÙŠÙ'}</div><div class="text-[10px] text-slate-500 select-all">${d.id}</div></div>
                            <div class="text-amber-500 font-bold font-mono">${u.highScore||0}</div>
                            <button class="bg-slate-700 p-2 rounded text-white btn-edit-user"><span class="material-symbols-rounded">edit</span></button>
                        </div>`;
                    div.querySelector('.btn-edit-user').onclick = () => {
                        window.currentUserEditId = d.id;
                        el('edit-name').value = u.username||''; el('edit-score').value = u.highScore||0; el('edit-banned').checked = u.isBanned||false; el('edit-pass').value = u.password || '';
                        // Preview Avatar
                        const prev = el('edit-avatar-preview'); prev.innerHTML = '';
                        if(u.customAvatar) { prev.innerHTML = `<img src="${u.customAvatar}" class="w-full h-full object-cover rounded-full">`; show('btn-del-avatar'); }
                        else if(u.avatar) { prev.innerHTML = `<span class="material-symbols-rounded text-amber-500 text-4xl">${u.avatar}</span>`; hide('btn-del-avatar'); }
                        else { prev.innerHTML = `<span class="material-symbols-rounded text-slate-500 text-4xl">person</span>`; hide('btn-del-avatar'); }
                        el('user-edit-modal').classList.add('active');
                    };
                    grid.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }
        el('btn-refresh-users').onclick = loadUsers; el('user-search').oninput = loadUsers;
        
        // Update User (Including Password & Avatar Upload)
        el('btn-save-user').onclick = async () => {
            const updates = { username: el('edit-name').value, highScore: parseInt(el('edit-score').value)||0, isBanned: el('edit-banned').checked };
            if(el('edit-pass').value) updates.password = el('edit-pass').value;
            
            // Avatar Upload Logic inside Save
            if(window.newAvatarBase64) {
                updates.customAvatar = window.newAvatarBase64;
            }

            await updateDoc(doc(db, "users", window.currentUserEditId), updates);
            toast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"); el('user-edit-modal').classList.remove('active'); loadUsers(); window.newAvatarBase64 = null;
        };

        el('btn-del-avatar').onclick = async () => {
             if(confirm("Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØµØµØ©ØŸ")) { await updateDoc(doc(db, "users", window.currentUserEditId), {customAvatar: null}); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù"); el('user-edit-modal').classList.remove('active'); loadUsers(); }
        };

        // New Avatar Upload Helper
        el('upload-new-avatar').onchange = (e) => {
             const file = e.target.files[0];
             if(!file) return;
             const reader = new FileReader();
             reader.onload = (event) => {
                 // Resize logic simple canvas
                 const img = new Image();
                 img.onload = () => {
                     const canvas = document.createElement('canvas');
                     const ctx = canvas.getContext('2d');
                     canvas.width = 150; canvas.height = 150; // Resize for performance
                     ctx.drawImage(img, 0, 0, 150, 150);
                     const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                     el('edit-avatar-preview').innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover rounded-full">`;
                     window.newAvatarBase64 = dataUrl; // Store temp
                 };
                 img.src = event.target.result;
             };
             reader.readAsDataURL(file);
        };

        // --- QUESTIONS MANAGEMENT ---
        let lastVisible = null; let isFetching = false;
        async function loadQuestions(more=false) {
            if(isFetching) return; isFetching = true;
            const grid = el('questions-grid'); const term = el('qs-search-input').value;
            const topicFilter = el('manage-topic-filter').value;
            
            if(!more) { grid.innerHTML = ''; lastVisible = null; }
            
            // Upgraded Logic: Force 500 limit & Filter by Topic
            let constr = [orderBy("createdAt", "desc"), limit(500)];
            
            if(topicFilter) constr = [where("topic", "==", topicFilter), ...constr];
            
            if(term) constr = [orderBy("question"), where("question", ">=", term), where("question", "<=", term+'\uf8ff'), limit(20)];
            
            if(more && lastVisible) constr.push(startAfter(lastVisible));

            // Trigger when Topic changes
            el('manage-topic-filter').onchange = () => loadQuestions(false);

            const snap = await getDocs(query(collection(db, "questions"), ...constr));
            if(!snap.empty) {
                lastVisible = snap.docs[snap.docs.length-1];
                // Hide 'Load More' if fetching 500 to simplify or keep it if needed
                if(snap.size >= 500) show('btn-load-more'); else hide('btn-load-more');
                
                snap.forEach(d => {
                    const q = d.data();
                    const div = document.createElement('div');
                    div.className = 'admin-item bg-slate-700/30 border-slate-700/50 fade-in';
                    div.innerHTML = `
                        <div class="flex-1 pr-2"><div class="text-white text-sm font-bold mb-1">${q.question}</div><div class="text-[10px] bg-slate-800 inline-block px-2 rounded text-slate-400">${q.topic}</div></div>
                        <div class="flex gap-2">
                            <button class="text-blue-400 p-2 btn-edit"><span class="material-symbols-rounded">edit_note</span></button>
                            <button class="text-red-400 p-2 btn-del"><span class="material-symbols-rounded">delete</span></button>
                        </div>`;
                    div.querySelector('.btn-edit').onclick = () => openEditQModal(d.id, q);
                    div.querySelector('.btn-del').onclick = async () => { if(confirm("Ø­Ø°ÙØŸ")) { await deleteDoc(doc(db,"questions",d.id)); div.remove(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù","delete"); } };
                    grid.appendChild(div);
                });
                el('qs-counter').innerText = grid.children.length;
            } else if(!more) grid.innerHTML = '<div class="text-center text-slate-500 py-4">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬</div>';
            isFetching = false;
        }
        el('btn-refresh-qs').onclick = () => loadQuestions(false); el('btn-load-more').onclick = () => loadQuestions(true); el('qs-search-input').oninput = () => { clearTimeout(window.st); window.st = setTimeout(()=>loadQuestions(false),500); };

        // Add Question
        el('btn-man-save').onclick = async () => {
            const q=el('man-q').value, topic=el('man-topic').value;
            if(!q || !topic) return toast("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©", "warning");
            const ansIdx = Array.from(document.getElementsByName('correct_ans_selector')).findIndex(r => r.checked);
            await addDoc(collection(db, "questions"), { 
                question: q, options: [el('man-o1').value, el('man-o2').value, el('man-o3').value, el('man-o4').value], 
                correctAnswer: ansIdx, explanation: el('man-exp').value, topic: topic, difficulty: 'Ù…ÙˆØ­Ø¯', createdAt: serverTimestamp() 
            });
            toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); el('man-q').value='';
        };

        // Edit Question Modal Logic
        window.openEditQModal = (id, data) => {
            window.currQId = id;
            el('edit-q-text').value = data.question;
            el('edit-o1').value = data.options[0]; el('edit-o2').value = data.options[1]; el('edit-o3').value = data.options[2]; el('edit-o4').value = data.options[3];
            el('edit-q-exp').value = data.explanation||"";
            document.getElementsByName('edit_ans_selector')[data.correctAnswer].checked = true;
            
            // Set Selects
            let catFound = ""; for(let c in topics) if(topics[c].includes(data.topic)) catFound = c;
            if(catFound) { el('edit-q-cat').value = catFound; el('edit-q-cat').dispatchEvent(new Event('change')); el('edit-q-topic').value = data.topic; }
            
            el('question-edit-modal').classList.add('active');
        };
        el('btn-save-edit-q').onclick = async () => {
            const ansIdx = Array.from(document.getElementsByName('edit_ans_selector')).findIndex(r => r.checked);
            await updateDoc(doc(db, "questions", window.currQId), {
                question: el('edit-q-text').value, options: [el('edit-o1').value, el('edit-o2').value, el('edit-o3').value, el('edit-o4').value],
                correctAnswer: ansIdx, explanation: el('edit-q-exp').value, topic: el('edit-q-topic').value
            });
            toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"); el('question-edit-modal').classList.remove('active'); loadQuestions(false);
        };
        document.querySelector('.close-q-modal').onclick = () => el('question-edit-modal').classList.remove('active');
        document.querySelector('.close-modal').onclick = () => el('user-edit-modal').classList.remove('active');

        // JSON Upload & Paste
        el('btn-upload-file').onclick = () => {
            const f = el('json-file-input').files[0], t = el('upload-topic').value;
            if(!f || !t) return toast("Ø§Ø®ØªØ± Ù…Ù„Ù ÙˆÙ…ÙˆØ¶ÙˆØ¹", "warning");
            const r = new FileReader();
            r.onload = async (e) => {
                try { const d = JSON.parse(e.target.result); let c=0; for(let q of d) { await addDoc(collection(db,"questions"),{...q, topic:t, difficulty:'Ù…ÙˆØ­Ø¯', createdAt:serverTimestamp()}); c++; } toast(`ØªÙ… Ø±ÙØ¹ ${c}`); } catch(x){ alert("Ø®Ø·Ø£ JSON"); }
            };
            r.readAsText(f);
        };
        el('btn-paste-upload').onclick = async () => {
            const txt = el('json-paste-area').value, t = el('paste-topic').value;
            if(!txt || !t) return toast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ ÙˆØ§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹", "warning");
            try { const d = JSON.parse(txt); let c=0; for(let q of d) { await addDoc(collection(db,"questions"),{...q, topic:t, difficulty:'Ù…ÙˆØ­Ø¯', createdAt:serverTimestamp()}); c++; } toast(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${c}`); el('json-paste-area').value=''; } catch(x){ alert("Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ JSON"); }
        };

        // Export & Backup
        window.checkExportBtn = () => el('btn-export-filtered').disabled = !el('export-topic').value;
        el('export-topic').onchange = checkExportBtn;
        el('btn-export-filtered').onclick = async () => {
            const t = el('export-topic').value;
            const snap = await getDocs(query(collection(db,"questions"), where("topic","==",t)));
            const data = []; snap.forEach(d => { let x = d.data(); delete x.createdAt; data.push(x); });
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); a.download = `Export_${t}.json`; a.click();
        };
        el('btn-backup').onclick = async () => {
            const snap = await getDocs(collection(db,"questions"));
            const data = []; snap.forEach(d => data.push(d.data()));
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)],{type:'application/json'})); a.download = `Full_Backup.json`; a.click();
        };
        el('btn-nuke').onclick = async () => {
            if(prompt("Ø£Ø¯Ø®Ù„ 'Ø­Ø°Ù Ø§Ù„ÙƒÙ„' Ù„Ù„ØªØ£ÙƒÙŠØ¯ (ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø³ÙŠØ­Ø°Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙ‚Ø·)") === "Ø­Ø°Ù Ø§Ù„ÙƒÙ„") {
                const s = await getDocs(collection(db,"questions")); const b = writeBatch(db);
                s.forEach(d => b.delete(d.ref)); await b.commit(); alert("ØªÙ… ØªØµÙÙŠØ± Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­"); loadStats();
            }
        };

        // Initial Load (no default loadQuestions call to save reads)
    </script>
</body>
</html>
